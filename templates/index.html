<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="/static/vault_logo.png">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #141e30 0%, #243b55 100%);
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --sidebar-bg: rgba(15, 23, 42, 0.92);
            --chat-bg: #0f172a;
            --text-main: #e5e7eb;
            --text-secondary: #9ca3af;
            --danger: #f87171;
            --success: #34d399;
            --warning: #facc15;
            --radius-main: 28px;
            --radius-elem: 14px;
        }

        body.theme-light {
            --primary-gradient: linear-gradient(135deg, #dfe9f3 0%, #ffffff 100%);
            --accent-color: #4f46e5;
            --accent-hover: #4338ca;
            --sidebar-bg: #ffffff;
            --chat-bg: #f3f4f6;
            --text-main: #111827;
            --text-secondary: #4b5563;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #eab308;
        }

        body.theme-dark {
            /* –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –∑–∞–¥–∞–Ω—ã, –∫–ª–∞—Å—Å –Ω—É–∂–µ–Ω –¥–ª—è —è–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
            color: var(--text-main);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-image: var(--primary-gradient);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-main);
            overflow: hidden;
        }

        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- –≠–ö–†–ê–ù –í–•–û–î–ê --- */
        #auth-view {
            padding: 42px 36px;
            background: radial-gradient(circle at top left, rgba(99, 102, 241, 0.24), transparent 55%),
                        radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.18), transparent 55%),
                        rgba(15, 23, 42, 0.94);
            backdrop-filter: blur(26px);
            border-radius: var(--radius-main);
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
            text-align: center;
            width: 100%;
            max-width: 420px;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        #auth-view h2 { margin-bottom: 30px; color: #e5e7eb; }
        
        input[type="text"], input[type="password"], textarea, input[type="number"] {
            width: 100%;
            padding: 14px 18px;
            margin: 8px 0;
            border-radius: var(--radius-elem);
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.8);
            font-size: 1rem;
            transition: 0.3s;
            font-family: inherit;
            color: var(--text-main);
        }
        input:focus, textarea:focus {
            border-color: var(--accent-color);
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.65);
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 15px;
            border: none;
            border-radius: var(--radius-elem);
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s ease;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.45);
        }
        button:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 14px 30px rgba(79, 70, 229, 0.65); }
        #register-button { background: transparent; color: var(--text-secondary); margin-top: 5px; box-shadow: none; }
        #register-button:hover { color: var(--accent-color); background: rgba(99, 102, 241, 0.12); transform: none; box-shadow: none; }

        /* --- –ì–õ–ê–í–ù–û–ï –û–ö–ù–û --- */
        #app {
            display: flex;
            width: 100%;
            max-width: none;
            height: 100vh;
            background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 60%),
                        radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.16), transparent 60%),
                        rgba(15, 23, 42, 0.96);
            border-radius: 0;
            box-shadow: 0 30px 65px -18px rgba(15, 23, 42, 0.95);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        /* --- –ë–û–ö–û–í–û–ï –ú–ï–ù–Æ (SIDEBAR) --- */
        #sidebar {
            width: 350px;
            min-width: 350px; 
            background: var(--sidebar-bg);
            border-right: 1px solid rgba(30, 64, 175, 0.5);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .tabs {
            display: flex;
            padding: 14px 14px 10px;
            background: transparent;
            gap: 10px;
            border-bottom: 1px solid rgba(30, 64, 175, 0.6);
        }
        .tab-button {
            background: transparent;
            color: #6b7280;
            padding: 10px;
            flex: 1;
            font-size: 1.1rem;
            box-shadow: none;
            margin: 0;
        }
        .tab-button:hover { background: rgba(30, 64, 175, 0.35); color: #e5e7eb; transform: none; }
        .tab-button.active { background: rgba(37, 99, 235, 0.85); color: #e5e7eb; }
        .tab-button:last-child:hover { color: var(--danger); background: rgba(229, 62, 62, 0.1); transform: none; }
        .admin-tab-button { color: #d69e2e !important; }
        
        .delete-message-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    margin-left: 10px;
    opacity: 0.5;
    font-size: 0.8rem;
    transition: opacity 0.2s;
}

.delete-message-btn:hover {
    opacity: 1;
    color: var(--danger);
}

.gift-message .delete-message-btn {
    color: rgba(255,255,255,0.8);
}

.gift-message .delete-message-btn:hover {
    color: white;
    background: rgba(229, 62, 62, 0.3);
}

        .coins-display {
            background: radial-gradient(circle at top left, #fbbf24, #f97316);
            color: #111827;
            padding: 7px 13px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.92rem;
            margin: 0 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 10px 20px rgba(251, 191, 36, 0.5);
        }

        .chat-list, .search-list {
            list-style: none;
            padding: 10px;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        .chat-item, .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 5px;
            border-radius: var(--radius-elem);
            cursor: pointer;
            transition: 0.2s;
        }
        .chat-item:hover, .user-item:hover { background-color: #f7fafc; transform: translateX(3px); }
        .chat-item.active { background-color: var(--accent-color); color: white; }
        .chat-item.active .name { color: white; }
        .chat-item.active .last-message { color: rgba(255,255,255,0.8); }

        .avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background: #cbd5e0;
            flex-shrink: 0;
        }
        .details { flex-grow: 1; overflow: hidden; }
        .name { font-weight: 600; margin-bottom: 2px; }
        .last-message { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- –ü–û–ò–°–ö –ò –ê–î–ú–ò–ù–ö–ê --- */
        #search-tab, #admin-tab, #settings-tab { padding: 20px; background: transparent; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #admin-gifts-list { max-height: 260px; overflow-y: auto; margin-top:10px; }
        
        .search-bar {
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            width: 100%;
            background: #f8fafc;
        }

        /* --- –ß–ê–¢ (MAIN CONTENT) --- */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.22), transparent 55%),
                        radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.2), transparent 55%),
                        var(--chat-bg);
            position: relative;
            min-width: 0;
        }
        
        
        .header {
            padding: 14px 22px;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(30, 64, 175, 0.85));
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(30, 64, 175, 0.8);
            display: flex;
            align-items: center;
            font-weight: 600;
            z-index: 5;
            height: 70px;
        }
        
        .back-button {
            display: none;
            margin-right: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –°–û–û–ë–©–ï–ù–ò–ô */
        #messages-container {
            flex-grow: 1;
            padding: 20px 22px 16px;
            overflow-y: auto;
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        
        .message-row { display: flex; align-items: flex-end; margin-bottom: 5px; animation: fadeIn 0.3s; }
        .message-row .avatar { width: 32px; height: 32px; margin-bottom: 5px; }
        
        .message {
            padding: 12px 16px;
            max-width: 70%;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            /* –ü–µ—Ä–µ–Ω–æ—Å –ø–æ —Å–ª–æ–≤–∞–º, –∞ –Ω–µ —Ä–∞–∑—Ä–µ–∑–∞—è —Å–ª–æ–≤–æ */
            word-break: normal;
            overflow-wrap: normal;
        }
        
        .received { align-self: flex-start; }
        .received .message { background: rgba(15, 23, 42, 0.96); border-radius: 18px 18px 18px 2px; margin-left: 5px; box-shadow: 0 8px 16px rgba(15,23,42,0.65); color:#e5e7eb; }
        .received .avatar { margin-right: 5px; }

        .sent { align-self: flex-end; justify-content: flex-end; }
        .sent .message { background: linear-gradient(135deg, #4f46e5, #06b6d4); color: white; border-radius: 18px 18px 2px 18px; margin-right: 5px; box-shadow: 0 10px 20px rgba(56, 189, 248, 0.5); }
        .sent .avatar { margin-left: 5px; }

        .message-info { display: block; margin-top: 4px; font-size: 0.7rem; opacity: 0.7; text-align: right; }

        .gift-row {
            justify-content: center;
            width: 100%;
        }

        .gift-row .avatar {
            display: none;
        }

        .gift-message {
            /* —Ñ–æ–Ω –∏ —Ñ–æ—Ä–º–∞ –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è; –∑–¥–µ—Å—å —É—Å–∏–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º */
            text-align: center;
            padding: 18px 24px !important;
            font-size: 1.05rem;
            max-width: 80%;
        }

        .gift-icon {
            display: block;
            margin-bottom: 5px;
        }
        
        .gift-img-content {
            width: 60px;
            height: 60px;
            object-fit: contain;
            display: inline-block;
        }
        
        .gift-emoji-content {
            font-size: 2rem;
            display: inline-block;
        }

        /* –¢–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ */
        .gift-celebration-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 200;
            animation: fadeOutCelebration 1.8s ease-out forwards;
        }

        .gift-celebration-card {
            background: radial-gradient(circle at top, rgba(255,255,255,0.2), transparent 70%),
                        linear-gradient(135deg, #f97316, #ec4899);
            padding: 18px 22px;
            border-radius: 20px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.7);
            text-align: center;
            color: #f9fafb;
            transform: scale(0.8);
            animation: popInCelebration 0.4s ease-out forwards;
        }

        .gift-celebration-title {
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .gift-celebration-gift {
            font-size: 2.4rem;
            margin-bottom: 4px;
        }

        .gift-celebration-text {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .gift-firework {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #facc15;
            box-shadow: 0 0 12px rgba(250,204,21,0.9);
            animation: fireworkBurst 0.9s ease-out forwards;
        }

        @keyframes popInCelebration {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeOutCelebration {
            0%,70% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes fireworkBurst {
            from { transform: scale(0.2); opacity: 1; }
            to { transform: scale(2.8); opacity: 0; }
        }

        #input-area {
            padding: 14px 18px 18px;
            background: rgba(15, 23, 42, 0.98);
            border-top: 1px solid rgba(30, 64, 175, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #message-input { margin: 0; border-radius: 999px; padding-left: 20px; flex: 1; background: rgba(15,23,42,0.9); color: var(--text-main); }
        #call-button { width: 46px; height: 46px; border-radius: 999px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; background: #10b981; box-shadow: 0 10px 20px rgba(16,185,129,0.45); }
        #call-button:hover { background: #059669; transform: translateY(-1px); }
        #send-button { width: 46px; height: 46px; border-radius: 999px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(56,189,248,0.5); }
        #gift-button { width: 46px; height: 46px; border-radius: 999px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; background: var(--warning); box-shadow: 0 10px 20px rgba(250,204,21,0.45); }
        #gift-button:hover { background: #fbbf24; }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–≤–æ–Ω–∫–∞ */
        @media (max-width: 768px) {
            #call-modal > div > div:first-child {
                grid-template-columns: 1fr !important;
            }
            #call-modal video {
                max-width: 100% !important;
            }
        }

        /* --- –ê–î–ú–ò–ù–ö–ê --- */
        #admin-user-list { overflow-y: auto; flex-grow: 1; }
        .admin-user-card {
            background: #f8fafc;
            border-left: 4px solid #d69e2e;
            padding: 15px;
            border-radius: var(--radius-elem);
            margin-bottom: 10px;
        }
        .admin-actions { display: flex; gap: 10px; margin-top: 10px; }
        .admin-actions button { width: auto; margin: 0; padding: 6px 12px; font-size: 0.85rem; box-shadow: none; }
        .admin-save-btn { background: var(--success); }
        .admin-ban-btn { background: var(--danger); }
        .admin-unban-btn { background: #3182ce; }
        .admin-nft-btn { background: #805ad5; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ü–†–û–§–ò–õ–Ø */
        #profile-modal, #gifts-modal {
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.5); 
            z-index: 100; 
            display: none; 
            align-items: center; 
            justify-content: center;
        }
        #profile-modal > div, #gifts-modal > div {
            background: white; 
            padding: 25px; 
            border-radius: var(--radius-main); 
            max-width: 380px; 
            width: 90%; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); 
            position: relative;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .gift-item {
            background: #f8fafc;
            border-radius: var(--radius-elem);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid transparent;
        }

        .gift-item:hover {
            background: #edf2f7;
            border-color: var(--warning);
        }

        .gift-item.selected {
            background: #fffaf0;
            border-color: var(--warning);
        }

        .gift-icon-large {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
            margin-bottom: 10px;
        }
        
        .gift-icon-large img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        
        .gift-icon-large span {
            font-size: 2.5rem;
        }

        .gift-price {
            background: var(--warning);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* --- NFT –ü–û–î–ê–†–ö–ò –ò –ú–ê–†–ö–ï–¢ --- */

        .nft-card {
            min-width: 140px;
            max-width: 180px;
            border-radius: 18px;
            padding: 10px 12px;
            color: #1a202c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .nft-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.2);
        }

        .nft-image-wrapper {
            width: 88px;
            height: 88px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .nft-image-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .nft-image-wrapper span {
            font-size: 2.2rem;
        }

        .nft-meta {
            font-size: 0.7rem;
            text-align: center;
            color: #2d3748;
        }

        .nft-market-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .nft-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            justify-content: center;
        }

        .nft-actions button {
            width: auto;
            margin: 0;
            padding: 4px 8px;
            font-size: 0.7rem;
            box-shadow: none;
        }

        /* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ (MOBILE) --- */
        @media (max-width: 850px) {
            #app { width: 100%; height: 100vh; border-radius: 0; }
            #sidebar { width: 100%; position: absolute; height: 100%; top: 0; left: 0; }
            #main-content { width: 100%; position: absolute; height: 100%; top: 0; left: 0; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
            
            body.chat-active #main-content { transform: translateX(0); }
            body.chat-active #sidebar { transform: translateX(-20%); opacity: 0; pointer-events: none; }
            
            .back-button { display: block; }
        }
    </style>
</head>
<body>
    <div id="auth-view" style="display: none;">
        <h2 style="display:flex; flex-direction:column; align-items:center; gap:14px;">
            <img src="/static/vault_logo.png" alt="Vault Logo" style="width:140px; height:auto; filter: drop-shadow(0 12px 28px rgba(0,0,0,0.7));">
            <span style="letter-spacing:0.18em; font-size:0.95rem; text-transform:uppercase; color:#9ca3af;">VAULT MESSENGER</span>
        </h2>
        <input type="text" id="auth-username" placeholder="–õ–æ–≥–∏–Ω (ID)">
        <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å">
        <input type="text" id="auth-display-name" placeholder="–í–∞—à–µ –∏–º—è" style="display:none;">
        
        <button id="login-button" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        <button id="register-button" onclick="showRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p id="auth-message"></p>
    </div>

    <div id="app" style="display: none;">
        <div id="sidebar">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('chats')" title="–ß–∞—Ç—ã"><i class="fas fa-comments"></i></button>
                <button class="tab-button" onclick="showTab('search')" title="–ü–æ–∏—Å–∫"><i class="fas fa-search"></i></button>
                <button class="tab-button" onclick="showTab('profile')" title="–ü—Ä–æ—Ñ–∏–ª—å"><i class="fas fa-user-circle"></i></button>
                <button class="tab-button" onclick="showTab('market')" title="–ú–∞—Ä–∫–µ—Ç NFT"><i class="fas fa-store"></i></button>
                <button class="tab-button" onclick="showTab('settings')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><i class="fas fa-cog"></i></button>
                <button id="admin-tab-button" class="tab-button admin-tab-button hidden" onclick="showTab('admin')" title="–ê–¥–º–∏–Ω"><i class="fas fa-user-shield"></i></button>
                <button class="tab-button" onclick="logout()" title="–í—ã—Ö–æ–¥"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div style="padding: 0 15px 10px; display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="coins-display">
                        <i class="fas fa-coins"></i>
                        <span id="coins-count">0</span>
                    </div>
                </div>
                <button onclick="openCreateRoomModal()" style="background:#1f2937; color:#e5e7eb; border:none; padding:7px 10px; border-radius:999px; font-size:0.78rem; cursor:pointer; width:100%; display:flex; align-items:center; justify-content:center; gap:6px;">
                    <i class="fas fa-bullhorn"></i>
                    <span>–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</span>
                </button>
            </div>
            
            <ul id="chats-tab" class="chat-list"></ul>
            
            <div id="search-tab" class="hidden">
                <input type="text" class="search-bar" id="search-input" placeholder="–ü–æ–∏—Å–∫ @ID..." onkeyup="handleSearch()">
                <ul id="search-list" class="search-list"></ul>
            </div>

            <div id="market-tab" class="hidden" style="padding: 20px; background: transparent; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                    <div>
                        <h3 style="margin:0; font-size:1.1rem;">NFT –ú–∞—Ä–∫–µ—Ç</h3>
                        <p style="margin:2px 0 0; font-size: 0.8rem; color:#9ca3af;">
                            –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–¥–∞—Ä–∫–æ–≤, –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
                        </p>
                    </div>
                </div>
                <div id="market-list" class="nft-market-grid" style="flex-grow:1; overflow-y:auto;"></div>
            </div>

            <div id="settings-tab" class="hidden">
                <h3 style="margin-top:0; margin-bottom: 10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <p style="margin-top:0; margin-bottom: 12px; font-size:0.85rem; color:#9ca3af;">
                    –õ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.
                </p>
                <div style="display:flex; flex-direction:column; gap:10px; max-width:360px;">
                    <label style="display:flex; align-items:center; justify-content:space-between; background:rgba(15,23,42,0.8); padding:10px 14px; border-radius:12px;">
                        <span style="font-size:0.9rem;">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <input type="checkbox" id="setting-theme">
                    </label>
                    <label style="display:flex; align-items:center; justify-content:space-between; background:rgba(15,23,42,0.8); padding:10px 14px; border-radius:12px;">
                        <span style="font-size:0.9rem;">–ó–≤—É–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                        <input type="checkbox" id="setting-sounds">
                    </label>
                    <label style="display:flex; align-items:center; justify-content:space-between; background:rgba(15,23,42,0.8); padding:10px 14px; border-radius:12px;">
                        <span style="font-size:0.9rem;">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º —á–∞—Ç–∞</span>
                        <input type="checkbox" id="setting-compact">
                    </label>
                    <label style="display:flex; align-items:center; justify-content:space-between; background:rgba(15,23,42,0.8); padding:10px 14px; border-radius:12px;">
                        <span style="font-size:0.9rem;">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å ¬´–æ–Ω–ª–∞–π–Ω¬ª</span>
                        <input type="checkbox" id="setting-status" checked>
                    </label>
                </div>
            </div>

            <div id="profile-tab" class="profile-view hidden">
                <img id="profile-avatar" class="avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä">
                <div style="text-align:center; margin-bottom:20px;">
                    <label for="avatar-input" style="cursor:pointer; color:var(--accent-color); font-weight:600;">
                        <i class="fas fa-camera"></i> –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
                    </label>
                    <input type="file" id="avatar-input" accept="image/*" style="display:none;" onchange="previewAvatar(this)">
                </div>
                <h3 id="profile-username-display" style="text-align:center; color:#718096; margin-top:0;"></h3>
                <div class="coins-display" style="justify-content:center; margin-bottom:15px;">
                    <i class="fas fa-coins"></i>
                    <span id="profile-coins-count">0</span> –º–æ–Ω–µ—Ç
                </div>
                
                <button onclick="openInventory()" style="background: #3182ce; margin-bottom: 15px;">
                    <i class="fas fa-box"></i> –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                </button>
                
                <label>–ò–º—è:</label>
                <input type="text" id="edit-display-name">
                <label>–û —Å–µ–±–µ:</label>
                <textarea id="edit-bio" rows="3"></textarea>
                <button onclick="saveProfileChanges()"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            
            <div id="admin-tab" class="hidden">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    <small style="color:#718096">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="admin-users-count">0</span></small>
                </div>
                
                <button onclick="openCreateGiftModal()" style="background: #d69e2e; margin-bottom: 15px; width: 100%;">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫
                </button>

                <button onclick="openAdminGifts()" style="background: #805ad5; margin-bottom: 15px; width: 100%;">
                    <i class="fas fa-gifts"></i> –ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏
                </button>
                
                <input type="text" class="search-bar" id="admin-search-input" placeholder="–ü–æ–∏—Å–∫ —é–∑–µ—Ä–∞ –ø–æ ID –∏–ª–∏ –∏–º–µ–Ω–∏..." onkeyup="filterAdminUsers()">
                
                <div id="admin-user-list">
                    <p style="text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>

                <hr style="margin:16px 0; border:none; border-top:1px solid rgba(148,163,184,0.3);" />

                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0; font-size:1rem;">–ú–æ–∏ –∫–∞–Ω–∞–ª—ã</h3>
                </div>
                <div id="admin-rooms-list" style="max-height:180px; overflow-y:auto;">
                    <p style="text-align:center; color:#888;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div class="header">
                <i class="fas fa-arrow-left back-button" onclick="closeChatMobile()"></i>
                
                <div id="companion-profile-link" style="cursor:pointer; display:none; flex-grow:1; display:flex; align-items:center;" onclick="if(activeChatPartnerId) fetchCompanionProfile(activeChatPartnerId)">
                    <img id="companion-avatar" class="avatar" src="" alt="Avatar" style="margin-right: 15px;">
                    <div>
                        <div id="companion-displayname" style="font-weight: 600; font-size: 1rem;">–ò–º—è</div>
                        <div id="companion-username" style="font-weight: 400; font-size: 0.85rem; color: var(--text-secondary);">
                            @username ¬∑ <span id="companion-status">–æ—Ñ—Ñ–ª–∞–π–Ω</span>
                        </div>
                    </div>
                </div>
                
                <div id="chat-start-title" style="display:flex; align-items:center; gap:10px; margin-left:auto;">
                    <img src="/static/vault_logo.png" alt="Vault Logo" style="width:42px; height:auto; opacity:0.95;">
                    <span style="letter-spacing:0.16em; font-size:0.9rem; text-transform:uppercase;">VAULT</span>
                    <span style="font-weight:400; font-size:0.9rem; color:var(--text-secondary);">Messenger</span>
                </div>
            </div>

            <div id="messages-container">
                <div id="chat-start-message" style="margin-top:auto; text-align:center; color:#a0aec0; padding-bottom: 50px;">
                    <i class="fas fa-paper-plane" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <div id="input-area" class="hidden">
                <button id="call-button" onclick="startCall()" style="width:46px; height:46px; border-radius:999px; margin:0; padding:0; display:flex; align-items:center; justify-content:center; background:#10b981; box-shadow:0 10px 20px rgba(16,185,129,0.45);" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
                    <i class="fas fa-phone"></i>
                </button>
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                <button id="gift-button" onclick="openGiftsModal()"><i class="fas fa-gift"></i></button>
            </div>
        </div>
        
        <div id="profile-modal">
            <div>
                <button id="close-profile-modal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2rem; color: var(--text-secondary); cursor: pointer;"><i class="fas fa-times"></i></button>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <img id="modal-avatar" class="avatar" src="" alt="Avatar" style="width: 100px; height: 100px; margin-bottom: 20px;">
                    <h3 id="modal-displayname" style="font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; text-align: center;"></h3>
                    <p id="modal-username" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 1rem; text-align: center;">@</p>
                    
                    <div style="width: 100%; background: #f8fafc; padding: 15px; border-radius: var(--radius-elem); text-align: left;">
                        <p style="font-weight: 600; margin-bottom: 5px; color: var(--text-main);">–û —Å–µ–±–µ:</p>
                        <p id="modal-bio" style="color: var(--text-secondary); white-space: pre-wrap; font-size: 0.95rem;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>
                    </div>
                    
                    <div id="modal-profile-gifts" style="width: 100%; margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <div id="gifts-modal">
            <div style="max-width: 450px;">
                <button id="close-gifts-modal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2rem; color: var(--text-secondary); cursor: pointer;"><i class="fas fa-times"></i></button>
                <h3 style="text-align: center; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫</h3>
                <p style="text-align: center; margin-bottom: 15px;">–í–∞—à –±–∞–ª–∞–Ω—Å: <span id="gifts-balance" class="coins-display" style="display: inline-flex; padding: 3px 8px;">0 –º–æ–Ω–µ—Ç</span></p>
                
                <div id="gifts-container" class="gifts-grid">
                    <!-- –ü–æ–¥–∞—Ä–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
                
                <button id="send-gift-button" onclick="sendGift()" style="margin-top: 20px;" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞ -->
        <div id="call-modal" style="display:none !important; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:300; align-items:center; justify-content:center;">
            <div style="background:#0f172a; border-radius:20px; padding:20px; max-width:800px; width:95%; position:relative;">
                <button id="close-call-modal" onclick="endCall()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; color:#e5e7eb; cursor:pointer; z-index:10;">
                    <i class="fas fa-times"></i>
                </button>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div style="background:#1e293b; border-radius:12px; padding:15px; text-align:center;">
                        <div style="font-size:0.9rem; color:#9ca3af; margin-bottom:8px;">–í—ã</div>
                        <video id="local-video" autoplay muted playsinline style="width:100%; max-width:300px; border-radius:8px; background:#000;"></video>
                        <div style="margin-top:8px;">
                            <button onclick="toggleMute()" id="mute-btn" style="background:#4f46e5; color:white; border:none; padding:8px 15px; border-radius:8px; margin:0 5px; cursor:pointer;">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button onclick="toggleVideo()" id="video-btn" style="background:#4f46e5; color:white; border:none; padding:8px 15px; border-radius:8px; margin:0 5px; cursor:pointer;">
                                <i class="fas fa-video"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="background:#1e293b; border-radius:12px; padding:15px; text-align:center;">
                        <div style="font-size:0.9rem; color:#9ca3af; margin-bottom:8px;" id="remote-user-name">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
                        <video id="remote-video" autoplay playsinline webkit-playsinline style="width:100%; max-width:300px; border-radius:8px; background:#000;"></video>
                        <div id="call-status" style="margin-top:8px; color:#9ca3af; font-size:0.85rem;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:center; gap:15px;">
                    <button onclick="endCall()" style="background:#ef4444; color:white; border:none; padding:12px 24px; border-radius:12px; font-size:1rem; cursor:pointer; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-phone-slash"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --------------------------------------
    // JAVASCRIPT –õ–û–ì–ò–ö–ê
    // --------------------------------------
    
    const API_URL = ''; 
    const GRAVATAR_BASE_URL = 'https://www.gravatar.com/avatar/';
    const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#cbd5e0"/><circle cx="50" cy="40" r="15" fill="#fff"/><circle cx="50" cy="80" r="25" fill="#fff"/></svg>';
    
    let currentUser = null;
    let activeChatPartnerId = null;
    let activeChatPartnerName = null;
    let activeChatPartnerAvatarBase64 = null;
    let activeChatPartnerEmailHash = null;
    let pollingInterval;
    let statusInterval;
    let newAvatarBase64 = null; 
    
    let adminUsersCache = [];
    let adminRoomsCache = [];
    let giftsList = [];
    let allGiftsMap = {}; // –ö–∞—Ä—Ç–∞ –≤—Å–µ—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–µ
    let selectedGiftId = null;
    
    let newGiftImageBase64 = null; // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞

    // NFT
    let nftMarket = [];
    let myNfts = [];
    const messageSound = new Audio('/static/message-notification-sound-imassage-on-iphone.mp3');
    messageSound.volume = 0.9;

    // --- SETTINGS (localStorage) ---
    function getSetting(key, defaultValue) {
        try {
            const raw = localStorage.getItem('vault_settings');
            if (!raw) return defaultValue;
            const obj = JSON.parse(raw);
            return obj.hasOwnProperty(key) ? obj[key] : defaultValue;
        } catch (e) {
            return defaultValue;
        }
    }

    function applyTheme() {
        const theme = getSetting('theme', 'dark');
        document.body.classList.remove('theme-dark', 'theme-light');
        const cls = theme === 'light' ? 'theme-light' : 'theme-dark';
        document.body.classList.add(cls);
    }

    function setSetting(key, value) {
        try {
            const raw = localStorage.getItem('vault_settings');
            const obj = raw ? JSON.parse(raw) : {};
            obj[key] = value;
            localStorage.setItem('vault_settings', JSON.stringify(obj));
        } catch (e) {}
    }

    function getNftBackground(variant) {
        const backgrounds = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
            'linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
            'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)',
            'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)',
        ];
        const idx = (variant && variant > 0 ? variant - 1 : 0) % backgrounds.length;
        return backgrounds[idx];
    }

    // --- UTILS ---
    
    function getGravatarUrl(hash, size = 80) { return `${GRAVATAR_BASE_URL}${hash}?s=${size}&d=identicon`; }
    function getAvatarUrl(base64Data, emailHash, size = 80) {
        if (base64Data && base64Data.startsWith('data:image')) return base64Data;
        return getGravatarUrl(emailHash, size);
    }
    function setAuthMessage(msg, isError = false) {
        const el = document.getElementById('auth-message');
        el.innerText = msg;
        el.style.color = isError ? '#e53e3e' : '#38a169';
    }
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 50);
    }

    function showGiftCelebration(giftName, giftImageUrl, fromUserId) {
        const overlay = document.createElement('div');
        overlay.className = 'gift-celebration-overlay';

        const fireworkPositions = [
            { top: '20%', left: '30%' },
            { top: '18%', left: '70%' },
            { top: '75%', left: '35%' },
            { top: '78%', left: '65%' }
        ];

        overlay.innerHTML = `
            <div class="gift-celebration-card">
                <div class="gift-celebration-title">–ü–æ–¥–∞—Ä–æ–∫!</div>
                <div class="gift-celebration-gift">
                    ${renderGiftVisual(giftImageUrl || 'üéÅ')}
                </div>
                <div class="gift-celebration-text">
                    –í—ã –ø–æ–ª—É—á–∏–ª–∏ "${giftName}" –æ—Ç @${fromUserId}
                </div>
            </div>
        `;

        fireworkPositions.forEach(pos => {
            const fw = document.createElement('div');
            fw.className = 'gift-firework';
            fw.style.top = pos.top;
            fw.style.left = pos.left;
            overlay.appendChild(fw);
        });

        document.body.appendChild(overlay);
        setTimeout(() => overlay.remove(), 1800);
    }

    async function updateCompanionStatus(userId) {
        try {
            const response = await fetch(`${API_URL}/api/status/${userId}`);
            const data = await response.json();
            if (data.status === 'success') {
                const span = document.getElementById('companion-status');
                if (!span) return;
                if (data.online) {
                    span.textContent = '–æ–Ω–ª–∞–π–Ω';
                    span.style.color = '#34d399';
                } else if (data.last_seen) {
                    let timeText = data.last_seen;
                    try {
                        const d = new Date(data.last_seen);
                        if (!isNaN(d.getTime())) {
                            timeText = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        }
                    } catch (e) {}
                    span.textContent = `–±—ã–ª(–∞) –≤ —Å–µ—Ç–∏ –≤ ${timeText}`;
                    span.style.color = 'var(--text-secondary)';
                } else {
                    span.textContent = '–æ—Ñ—Ñ–ª–∞–π–Ω';
                    span.style.color = 'var(--text-secondary)';
                }
            }
        } catch (e) {
            // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        }
    }

    function previewAvatar(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('profile-avatar').src = e.target.result;
                newAvatarBase64 = e.target.result;
            };
            reader.readAsDataURL(file); 
        }
    }
    
    // –•–µ–ª–ø–µ—Ä –¥–ª—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤)
    function resizeImage(file, maxWidth, maxHeight) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL(file.type));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    
    // –•–µ–ª–ø–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏–∑—É–∞–ª–∞ –ø–æ–¥–∞—Ä–∫–∞ (–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –≠–º–æ–¥–∑–∏)
    function renderGiftVisual(source) {
        if (!source) return 'üéÅ';
        // –ï—Å–ª–∏ —ç—Ç–æ URL –∏–ª–∏ Base64
        if (source.startsWith('http') || source.startsWith('data:image')) {
            return `<img src="${source}" class="gift-img-content" alt="Gift">`;
        }
        // –ò–Ω–∞—á–µ —ç—Ç–æ —ç–º–æ–¥–∑–∏
        return `<span class="gift-emoji-content">${source}</span>`;
    }

    function updateCoinsDisplay(coins) {
        document.getElementById('coins-count').textContent = coins;
        document.getElementById('profile-coins-count').textContent = coins;
        document.getElementById('gifts-balance').innerHTML = `<i class="fas fa-coins"></i> ${coins}`;
    }
    
    // --- AUTH ---

    function showRegister() {
        document.getElementById('login-button').style.display = 'none';
        document.getElementById('register-button').onclick = handleRegister;
        document.getElementById('register-button').innerText = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        document.getElementById('auth-display-name').style.display = 'block';
        setAuthMessage("");
    }

    async function handleRegister() {
        const username = document.getElementById('auth-username').value;
        const password = document.getElementById('auth-password').value;
        const displayName = document.getElementById('auth-display-name').value;

        try {
            const response = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, displayName })
            });
            const data = await response.json();
            if (data.status === 'success') {
                setAuthMessage(data.message + ". –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
                document.getElementById('auth-display-name').style.display = 'none';
                document.getElementById('login-button').style.display = 'block';
                document.getElementById('register-button').innerText = '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
                document.getElementById('register-button').onclick = showRegister;
            } else setAuthMessage(data.message, true);
        } catch (e) { setAuthMessage("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true); }
    }

    async function handleLogin() {
        const username = document.getElementById('auth-username').value;
        const password = document.getElementById('auth-password').value;
        try {
            const response = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (data.status === 'success') {
                currentUser = data.user;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                initializeApp();
            } else setAuthMessage(data.message, true);
        } catch (e) { setAuthMessage("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true); }
    }

    function logout() {
        currentUser = null;
        activeChatPartnerId = null;
        clearInterval(pollingInterval);
        if (window.callCheckInterval) clearInterval(window.callCheckInterval);
        if (currentCallId) endCall();
        localStorage.removeItem('vault_user');
        document.getElementById('app').style.display = 'none';
        document.getElementById('auth-view').style.display = 'block';
        document.getElementById('auth-username').value = '';
        document.getElementById('auth-password').value = '';
        setAuthMessage('');
        document.body.classList.remove('chat-active');
    }

    // --- APP LOGIC ---
    
    async function initializeApp() {
        document.getElementById('auth-view').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        
        const adminButton = document.getElementById('admin-tab-button');
        if (currentUser.role === 'admin') adminButton.classList.remove('hidden');
        else adminButton.classList.add('hidden');

        updateCoinsDisplay(currentUser.coins || 15);
        showTab('chats');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∞—Ä–∫–∏ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∫—ç—à –±—ã–ª –≥–æ—Ç–æ–≤ –¥–ª—è —á–∞—Ç–∞
        await fetchAllGifts(); 
        
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(() => {
            if (activeChatPartnerId) renderMessages(activeChatPartnerId, false);
            renderChatList();
        }, 8000);

        if (statusInterval) clearInterval(statusInterval);
        statusInterval = setInterval(() => {
            if (activeChatPartnerId && getSetting('status', true)) {
                updateCompanionStatus(activeChatPartnerId);
            }
        }, 15000);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if (window.callCheckInterval) {
            clearInterval(window.callCheckInterval);
            window.callCheckInterval = null;
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        if (currentUser && currentUser.id) {
            window.callCheckInterval = setInterval(checkIncomingCalls, 2000);
        }
    }

    function showTab(tabName) {
        const tabs = ['chats', 'search', 'profile', 'admin', 'market', 'settings'];
        if (tabName === 'admin' && currentUser.role !== 'admin') tabName = 'chats'; 

        tabs.forEach(tab => {
            const tabEl = document.getElementById(`${tab}-tab`);
            const btnEl = document.querySelector(`.tab-button[onclick*="${tab}"]`);
            if (tabEl) tabEl.classList.toggle('hidden', tab !== tabName);
            if (btnEl) btnEl.classList.toggle('active', tab === tabName);
        });
        
        if (tabName === 'profile') loadProfile();
        if (tabName === 'chats') renderChatList();
        if (tabName === 'admin') loadAdminUsers(); 
        if (tabName === 'search') {
            document.getElementById('search-input').value = ''; 
            document.getElementById('search-list').innerHTML = '';
        }
        if (tabName === 'market') {
            loadMarket();
        }
    }
    
    function closeChatMobile() {
        document.body.classList.remove('chat-active');
        activeChatPartnerId = null;
        activeChatIsChannel = false;
        activeChatRole = null;
        
        document.getElementById('chat-start-title').style.display = 'block';
        document.getElementById('companion-profile-link').style.display = 'none';
        
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('gift-button').style.display = 'flex';
        document.getElementById('call-button').style.display = 'flex';
    }

    // --- CHATS & MESSAGES ---

    async function renderChatList() {
        const chatList = document.getElementById('chats-tab');
        try {
            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'chats', user_id: currentUser.id })
            });
            const data = await response.json();
            
            let htmlContent = '';
            if (data.status === 'success') {
                if (data.chats.length === 0) {
                     htmlContent = '<li style="padding: 20px; text-align:center; color:#a0aec0;">–ù–µ—Ç —á–∞—Ç–æ–≤</li>';
                } else {
                    data.chats.forEach(partner => {
                        const avatarSrc = getAvatarUrl(partner.avatarBase64, partner.emailHash, 50);
                        const isActive = activeChatPartnerId === partner.id ? ' active' : '';
                        htmlContent += `
                            <li class="chat-item${isActive}" onclick="openChat('${partner.id}', '${partner.displayName}', '${partner.avatarBase64}', '${partner.emailHash}')">
                                <img class="avatar" src="${avatarSrc}">
                                <div class="details">
                                    <div class="name">${partner.displayName}</div>
                                    <div class="last-message">@${partner.id}</div>
                                </div>
                            </li>`;
                    });
                }
            } else {
                htmlContent = '<li style="padding: 20px; text-align:center; color:#a0aec0;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</li>';
            }
            chatList.innerHTML = htmlContent;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
            chatList.innerHTML = '<li style="padding: 20px; text-align:center; color:#e53e3e;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</li>';
        }
    }
    
    let activeChatIsChannel = false;
    let activeChatRole = null;

    function openChat(pId, pName, pAvatar, pHash, isChannel = false) {
        activeChatPartnerId = pId;
        activeChatPartnerName = pName;
        activeChatPartnerAvatarBase64 = pAvatar;
        activeChatPartnerEmailHash = pHash;
        activeChatIsChannel = isChannel || false;

        document.getElementById('input-area').classList.remove('hidden');
        
        const profileLinkEl = document.getElementById('companion-profile-link');
        profileLinkEl.style.display = 'flex';
        document.getElementById('chat-start-title').style.display = 'none';

        const avatarSrc = isChannel 
            ? (pAvatar || DEFAULT_AVATAR)
            : getAvatarUrl(pAvatar, pHash, 50);
        document.getElementById('companion-avatar').src = avatarSrc;
        document.getElementById('companion-displayname').innerText = pName;
        
        if (isChannel) {
            document.getElementById('companion-username').innerHTML = `üì¢ –ö–∞–Ω–∞–ª`;
            // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            const statusEl = document.getElementById('companion-status');
            if (statusEl) statusEl.style.display = 'none';
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–∞—Ä–∫–∞ –∏ –∑–≤–æ–Ω–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            document.getElementById('gift-button').style.display = 'none';
            document.getElementById('call-button').style.display = 'none';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª–µ
            checkChannelRole(pId);
        } else {
            document.getElementById('companion-username').innerHTML = `@${pId} ¬∑ <span id="companion-status">...</span>`;
            const statusEl = document.getElementById('companion-status');
            if (statusEl) statusEl.style.display = 'inline';
            document.getElementById('gift-button').style.display = 'flex';
            document.getElementById('call-button').style.display = 'flex';
            activeChatRole = null;
        }
        
        document.body.classList.add('chat-active');

        if (getSetting('status', true) && !isChannel) {
            updateCompanionStatus(pId);
        }

        renderMessages(pId, true); 
        renderChatList(); 
    }

    async function checkChannelRole(roomId) {
        try {
            const response = await fetch(`${API_URL}/api/rooms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'list', user_id: currentUser.id })
            });
            const data = await response.json();
            if (data.status === 'success') {
                const room = data.rooms.find(r => r.id === roomId);
                if (room) {
                    activeChatRole = room.role;
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ owner/admin
                    if (room.role !== 'owner' && room.role !== 'admin') {
                        document.getElementById('input-area').classList.add('hidden');
                    } else {
                        document.getElementById('input-area').classList.remove('hidden');
                    }
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', e);
        }
    }
    
    async function renderMessages(partnerId, forceScroll = false) {
        const container = document.getElementById('messages-container');
        const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

        try {
            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'history', user_a: currentUser.id, user_b: partnerId })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                let htmlContent = '';
                if (data.messages.length === 0) {
                     htmlContent = '<div style="margin-top:auto; text-align:center; color:#a0aec0; padding-bottom:50px;"><p>–ß–∞—Ç –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.</p></div>';
                } else {
                    const partnerAvatar = activeChatPartnerAvatarBase64;
                    const partnerHash = activeChatPartnerEmailHash;
                    
                    data.messages.forEach(msg => {
                        const isSent = msg.sender === currentUser.id;
                        const senderBase64 = isSent ? currentUser.avatarBase64 : partnerAvatar;
                        const senderHash = isSent ? currentUser.emailHash : partnerHash;
                        const avatarSrc = getAvatarUrl(senderBase64, senderHash, 35);
                        const rowClass = isSent ? 'sent' : 'received';
                        
                        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –ù–ï –ø–æ–¥–∞—Ä–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                        const canDelete = isSent && !msg.is_gift;
                        const deleteButton = canDelete ? 
                            `<button class="delete-message-btn" onclick="deleteMessage('${msg.uuid}')" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                                <i class="fas fa-trash"></i>
                            </button>` : '';

                        const readMark = isSent && msg.is_read ? ' ¬∑ <span style="color:#34d399;">–ø—Ä–æ—á–∏—Ç–∞–Ω–æ</span>' : '';

                        if (msg.is_gift) {
                            htmlContent += `
                                <div class="message-row ${rowClass} gift-row" data-uuid="${msg.uuid}">
                                    <img class="avatar" src="${avatarSrc}">
                                    <div class="message ${rowClass} gift-message">
                                        <span class="gift-icon">${getGiftIcon(msg.gift_id)}</span>
                                        ${msg.text.replace('–ü–æ–¥–∞—Ä–æ–∫: ', '')} 
                                        <span class="message-info">${msg.timestamp}${readMark}</span>
                                        ${deleteButton}
                                    </div>
                                </div>`;
                        } else {
                            htmlContent += `
                                <div class="message-row ${rowClass}" data-uuid="${msg.uuid}">
                                    <img class="avatar" src="${avatarSrc}">
                                    <div class="message ${rowClass}">
                                        ${msg.text} 
                                        <span class="message-info">${msg.timestamp}${readMark}</span>
                                        ${deleteButton}
                                    </div>
                                </div>`;
                        }
                    });
                }
                
                container.innerHTML = htmlContent;
                
                // –∑–≤—É–∫ –∏ —Ç–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ –Ω–æ–≤–æ–º –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                try {
                    const lastMsg = data.messages[data.messages.length - 1];
                    window.__lastMessageByChat = window.__lastMessageByChat || {};
                    const prevId = window.__lastMessageByChat[partnerId];
                    window.__lastMessageByChat[partnerId] = lastMsg ? lastMsg.uuid : null;
                    const isNewIncoming = lastMsg && prevId && prevId !== lastMsg.uuid && lastMsg.sender !== currentUser.id;
                    if (isNewIncoming) {
                        if (getSetting('sounds', true)) {
                            messageSound.currentTime = 0;
                            messageSound.play().catch(() => {});
                        }
                        if (lastMsg.is_gift) {
                            const giftMeta = allGiftsMap[lastMsg.gift_id] || {};
                            showGiftCelebration(giftMeta.name || lastMsg.text.replace('–ü–æ–¥–∞—Ä–æ–∫: ', ''), giftMeta.image_url, lastMsg.sender);
                        }
                    }
                } catch (e) {}

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                const style = document.createElement('style');
                style.textContent = `
                    .delete-message-btn {
                        background: none;
                        border: none;
                        color: var(--text-secondary);
                        cursor: pointer;
                        margin-left: 10px;
                        opacity: 0.5;
                        font-size: 0.8rem;
                        transition: opacity 0.2s;
                        padding: 2px 5px;
                        border-radius: 3px;
                    }
                    
                    .delete-message-btn:hover {
                        opacity: 1;
                        background: rgba(229, 62, 62, 0.1);
                        color: var(--danger);
                    }
                    
                    .sent .delete-message-btn {
                        color: rgba(255, 255, 255, 0.7);
                    }
                    
                    .sent .delete-message-btn:hover {
                        color: white;
                        background: rgba(255, 255, 255, 0.2);
                    }
                    
                    .gift-message .delete-message-btn {
                        color: rgba(255, 255, 255, 0.7);
                    }
                    
                    .gift-message .delete-message-btn:hover {
                        color: white;
                        background: rgba(255, 255, 255, 0.2);
                    }
                `;
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                const oldStyle = document.getElementById('delete-message-styles');
                if (oldStyle) oldStyle.remove();
                style.id = 'delete-message-styles';
                document.head.appendChild(style);
                
                if (forceScroll || isAtBottom) {
                    scrollToBottom();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            container.innerHTML = '<div style="text-align:center; color:#e53e3e; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    async function deleteMessage(messageId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            return;
        }
        
        if (!activeChatPartnerId) {
            alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/api/delete_message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    user_id: currentUser.id,
                    message_id: messageId,
                    chat_partner_id: activeChatPartnerId
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ DOM
                const messageElement = document.querySelector(`[data-uuid="${messageId}"]`);
                if (messageElement) {
                    messageElement.style.opacity = '0.5';
                    messageElement.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        messageElement.remove();
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                        const messages = document.querySelectorAll('.message-row');
                        if (messages.length === 0) {
                            const container = document.getElementById('messages-container');
                            container.innerHTML = '<div style="margin-top:auto; text-align:center; color:#a0aec0; padding-bottom:50px;"><p>–ß–∞—Ç –ø—É—Å—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.</p></div>';
                        }
                    }, 300);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification(data.message, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –ø–æ–¥–∞—Ä–æ–∫
                if (data.new_balance !== undefined) {
                    currentUser.coins = data.new_balance;
                    localStorage.setItem('vault_user', JSON.stringify(currentUser));
                    updateCoinsDisplay(data.new_balance);
                }
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        if (type === 'success') {
            notification.style.background = 'var(--success)';
        } else if (type === 'error') {
            notification.style.background = 'var(--danger)';
        } else {
            notification.style.background = 'var(--accent-color)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–æ–¥–∞—Ä–∫–∞
    function getGiftIcon(giftId) {
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ–¥–∞—Ä–æ–∫ –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
        const gift = allGiftsMap[giftId];
        if (gift) {
            return renderGiftVisual(gift.image_url);
        }
        
        // –§–æ–ª–ª–±–µ–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤
        const giftIcons = {
            'gift1': '‚ù§Ô∏è',
            'gift2': '‚≠ê',
            'gift3': 'üéÅ',
            'gift4': 'üèÜ',
            'gift5': 'üëë',
            'gift6': 'üöÄ'
        };
        const icon = giftIcons[giftId];
        return icon ? renderGiftVisual(icon) : 'üéÅ';
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text || !activeChatPartnerId) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
        if (activeChatIsChannel && activeChatRole !== 'owner' && activeChatRole !== 'admin') {
            showNotification('–¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å', 'error');
            return;
        }
        
        const messageText = text;
        input.value = '';
        
        const tempContainer = document.getElementById('messages-container');
        const tempMsgHtml = `
            <div class="message-row sent">
                <img class="avatar" src="${getAvatarUrl(currentUser.avatarBase64, currentUser.emailHash, 35)}">
                <div class="message sent">
                    ${messageText} 
                    <span class="message-info">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})} (–æ—Ç–ø—Ä–∞–≤–∫–∞...)</span>
                </div>
            </div>`;
        tempContainer.insertAdjacentHTML('beforeend', tempMsgHtml);
        scrollToBottom();

        try {
            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'send', 
                    sender_id: currentUser.id, 
                    receiver_id: activeChatPartnerId, 
                    text: messageText 
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                await renderMessages(activeChatPartnerId, true);
                renderChatList();
            } else {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', data.message);
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'error');
        }
    }

    // --- SEARCH ---

    async function subscribeChannel(roomId, name, avatarBase64) {
        try {
            const response = await fetch(`${API_URL}/api/rooms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'join',
                    room_id: roomId,
                    user_id: currentUser.id
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(`–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª "${name}"`, 'success');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                renderChatList();
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç—ã
                showTab('chats');
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª
                setTimeout(() => {
                    openChat(roomId, name, avatarBase64 || '', '', true);
                }, 300);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª', 'error');
        }
    }

    async function handleSearch() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const list = document.getElementById('search-list');
        list.innerHTML = '';
        if (term.length < 2) return;

        try {
            const response = await fetch(`${API_URL}/api/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_user_id: currentUser.id, term: term })
            });
            const data = await response.json();

            if (data.status === 'success') {
                data.results.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'user-item';

                    if (item.kind === 'channel') {
                        const avatarSrc = item.avatarBase64 || DEFAULT_AVATAR;
                        li.innerHTML = `
                            <img class="avatar" src="${avatarSrc}">
                            <div class="details">
                                <div class="name">${item.name}</div>
                                <div class="id">üì¢ –ö–∞–Ω–∞–ª</div>
                            </div>
                            <button class="tab-button" style="width:auto; background:#4f46e5; color:white;" 
                                    onclick="subscribeChannel('${item.id}', '${item.name}', '${item.avatarBase64 || ''}')">
                                –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                            </button>`;
                    } else {
                        const avatarSrc = getAvatarUrl(item.avatarBase64, item.emailHash, 50);
                        li.innerHTML = `
                            <img class="avatar" src="${avatarSrc}">
                            <div class="details">
                                <div class="name">${item.displayName}</div>
                                <div class="id">@${item.id}</div>
                            </div>
                            <button class="tab-button" style="width:auto; background:#38a169; color:white;" 
                                    onclick="openChat('${item.id}', '${item.displayName}', '${item.avatarBase64}', '${item.emailHash}'); showTab('chats');">
                                –ß–∞—Ç
                            </button>`;
                    }
                    list.appendChild(li);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            list.innerHTML = '<li style="padding: 10px; text-align:center; color:#e53e3e;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</li>';
        }
    }

    // --- PROFILE ---

    async function loadProfile() {
        document.getElementById('profile-username-display').innerText = `@${currentUser.id}`;
        document.getElementById('profile-avatar').src = getAvatarUrl(currentUser.avatarBase64, currentUser.emailHash, 100);
        try {
            const response = await fetch(`${API_URL}/api/profile/${currentUser.id}`);
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('edit-display-name').value = data.profile.displayName;
                document.getElementById('edit-bio').value = data.profile.bio;
                const currentAvatar = data.profile.avatarBase64 || "";
                document.getElementById('profile-avatar').src = getAvatarUrl(currentAvatar, currentUser.emailHash, 100);
                updateCoinsDisplay(data.profile.coins || 0);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
        }
        newAvatarBase64 = null; 
        document.getElementById('avatar-input').value = null; 
    }

    async function saveProfileChanges() {
        const displayName = document.getElementById('edit-display-name').value;
        const bio = document.getElementById('edit-bio').value;
        const bodyData = { displayName, bio };
        if (newAvatarBase64 !== null) bodyData.avatarBase64 = newAvatarBase64;

        try {
            const response = await fetch(`${API_URL}/api/profile/${currentUser.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            const data = await response.json();
            if (data.status === 'success') {
                currentUser.displayName = data.profile.displayName;
                currentUser.avatarBase64 = data.profile.avatarBase64 || "";
                currentUser.coins = data.profile.coins || 0;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                updateCoinsDisplay(currentUser.coins);
                showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                loadProfile();
            } else showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
        }
    }
    
    // --- PROFILE VIEWING ---

    function openProfileModal(user) {
        document.getElementById('modal-avatar').src = getAvatarUrl(user.avatarBase64, user.emailHash, 100) || DEFAULT_AVATAR;
        document.getElementById('modal-displayname').textContent = user.displayName;
        document.getElementById('modal-username').textContent = `@${user.id}`;
        const bioText = user.bio && user.bio.trim() ? user.bio : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–±–µ –Ω–µ —É–∫–∞–∑–∞–Ω–∞.';
        document.getElementById('modal-bio').textContent = bioText;
        
        const profileGiftsContainer = document.getElementById('modal-profile-gifts');
        const normalGifts = user.profile_gifts || [];
        const nftGifts = user.profile_nft_gifts || [];
        const all = normalGifts.concat(nftGifts);
        if (all.length > 0) {
            profileGiftsContainer.innerHTML = `
                <div style="margin-top: 20px;">
                    <p style="font-weight: 600; margin-bottom: 10px; color: var(--text-main);">–ü–æ–¥–∞—Ä–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ:</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        ${all.map(gift => {
                            const isNft = !!gift.token_id;
                            const bg = isNft && gift.bg_variant ? getNftBackground(gift.bg_variant) : 'linear-gradient(135deg,#1f2937,#111827)';
                            const extraInfo = isNft
                                ? `#${gift.serial_number || ''} ¬∑ ${gift.price || 0} –º–æ–Ω–µ—Ç`
                                : (gift.is_rare ? '–†–µ–¥–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫' : '–û–±—ã—á–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫');
                            return `
                            <div style="flex:0 0 120px; text-align: center; background:${bg}; padding: 10px; border-radius: 14px; min-width: 100px; color:#e5e7eb; box-shadow:0 10px 20px rgba(0,0,0,0.4);">
                                <div style="font-size: 1.7rem; display:flex; justify-content:center; margin-bottom:4px;">
                                    ${renderGiftVisual(gift.image_url)}
                                </div>
                                <div style="font-size: 0.75rem; font-weight:600; margin-bottom:2px;">${gift.name}</div>
                                <div style="font-size:0.7rem; color:#d1d5db;">${extraInfo}</div>
                                ${gift.is_rare ? '<div style="color: #facc15; font-size: 0.6rem; margin-top:2px;">‚ö° –†–µ–¥–∫–∏–π</div>' : ''}
                                ${isNft ? '<div style="color:#a5b4fc; font-size:0.6rem; margin-top:2px;">NFT</div>' : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        } else {
            profileGiftsContainer.innerHTML = '';
        }
        
        document.getElementById('profile-modal').style.display = 'flex';
    }

    function closeProfileModal() {
        document.getElementById('profile-modal').style.display = 'none';
    }

    async function fetchCompanionProfile(userId) {
        try {
            const response = await fetch(`${API_URL}/api/user/${userId}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                openProfileModal(data.user);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.', 'error');
        }
    }
    
    // --- ADMIN PANEL & SEARCH ---

    async function loadAdminUsers() {
        const userListEl = document.getElementById('admin-user-list');
        userListEl.innerHTML = '<p style="text-align: center; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        
        try {
            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'list', admin_id: currentUser.id })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                adminUsersCache = data.users;
                document.getElementById('admin-users-count').innerText = adminUsersCache.length;
                renderAdminList(adminUsersCache);
            } else {
                userListEl.innerHTML = `<p style="text-align: center; color: #e53e3e;">–û—à–∏–±–∫–∞: ${data.message}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            userListEl.innerHTML = `<p style="text-align: center; color: #e53e3e;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>`;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã/–∫–∞–Ω–∞–ª—ã –¥–ª—è –∞–¥–º–∏–Ω–∞
        try {
            const respRooms = await fetch(`${API_URL}/api/rooms`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'list', user_id: currentUser.id })
            });
            const roomsData = await respRooms.json();
            const listEl = document.getElementById('admin-rooms-list');
            if (roomsData.status === 'success') {
                adminRoomsCache = roomsData.rooms || [];
                renderAdminRooms(adminRoomsCache);
            } else if (listEl) {
                listEl.innerHTML = `<p style="text-align:center; color:#e53e3e;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</p>`;
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', e);
            const listEl = document.getElementById('admin-rooms-list');
            if (listEl) listEl.innerHTML = `<p style="text-align:center; color:#e53e3e;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</p>`;
        }
    }

    function renderAdminList(users) {
        const userListEl = document.getElementById('admin-user-list');
        if (users.length === 0) {
            userListEl.innerHTML = '<p style="text-align:center; color:#a0aec0;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
            return;
        }

        let html = '';
        users.forEach(user => {
            const isBanned = user.is_banned === 1;
            const bannedText = isBanned ? '<span style="color:red; font-weight:bold;">(BAN)</span>' : '';
            html += `
                <div class="admin-user-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">@${user.id} ${bannedText}</h4>
                        <span style="font-size:0.8em; background:#edf2f7; padding:2px 6px; border-radius:4px;">${user.role}</span>
                    </div>
                    <div style="margin-top:5px; color:#718096; font-size:0.9em;">–ú–æ–Ω–µ—Ç—ã: ${user.coins || 0}</div>
                    
                    <div style="margin-top:10px;">
                        <input type="text" id="admin-name-${user.id}" value="${user.displayName}" placeholder="–ò–º—è" style="margin-bottom:5px; padding:8px;">
                        <input type="password" id="admin-pass-${user.id}" placeholder="–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å" style="margin-bottom:5px; padding:8px;">
                        <input type="number" id="admin-coins-${user.id}" value="${user.coins || 0}" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç" style="margin-bottom:5px; padding:8px;" min="0">
                    </div>
                    
                    <div class="admin-actions">
                        <button class="admin-save-btn" onclick="adminEditUser('${user.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="admin-nft-btn" onclick="adminCreateNftForUser('${user.id}')">NFT –ø–æ–¥–∞—Ä–æ–∫</button>
                        ${isBanned 
                            ? `<button class="admin-unban-btn" onclick="adminBanUser('${user.id}', 0)">–†–∞–∑–±–∞–Ω–∏—Ç—å</button>`
                            : `<button class="admin-ban-btn" onclick="adminBanUser('${user.id}', 1)">–ó–∞–±–∞–Ω–∏—Ç—å</button>`
                        }
                    </div>
                </div>`;
        });
        userListEl.innerHTML = html;
    }

    function filterAdminUsers() {
        const term = document.getElementById('admin-search-input').value.toLowerCase();
        const filtered = adminUsersCache.filter(user => 
            user.id.toLowerCase().includes(term) || 
            user.displayName.toLowerCase().includes(term)
        );
        renderAdminList(filtered);
    }
    
    async function adminEditUser(targetId) {
        const newDisplayName = document.getElementById(`admin-name-${targetId}`).value;
        const newPassword = document.getElementById(`admin-pass-${targetId}`).value;
        const newCoins = parseInt(document.getElementById(`admin-coins-${targetId}`).value);
        
        const bodyData = { 
            action: 'edit', admin_id: currentUser.id, target_id: targetId, displayName: newDisplayName,
        };
        if (newPassword.trim()) bodyData.password = newPassword.trim();
        if (!isNaN(newCoins)) bodyData.coins = newCoins;

        try {
            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            const data = await response.json();
            showNotification(data.message, data.status === 'success' ? 'success' : 'error');
            if (data.status === 'success') document.getElementById(`admin-pass-${targetId}`).value = ''; 
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }
    
    async function adminBanUser(targetId, isBanned) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${isBanned ? '–∑–∞–±–∞–Ω–∏—Ç—å' : '—Ä–∞–∑–±–∞–Ω–∏—Ç—å'} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${targetId}?`)) return;
        try {
            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'edit', admin_id: currentUser.id, target_id: targetId, is_banned: isBanned, 
                })
            });
            const data = await response.json();
            showNotification(data.message, data.status === 'success' ? 'success' : 'error');
            if (data.status === 'success') loadAdminUsers(); 
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }

    // --- –ê–î–ú–ò–ù: –ü–†–û–°–ú–û–¢–† –°–í–û–ò–• –ü–û–î–ê–†–ö–û–í –ò –ê–ü–ì–†–ï–ô–î –í NFT ---

    async function openAdminGifts() {
        try {
            const response = await fetch(`${API_URL}/api/admin/my_gifts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_id: currentUser.id })
            });
            const data = await response.json();
            if (data.status === 'success') {
                renderAdminGiftsModal(data.gifts || []);
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –∞–¥–º–∏–Ω–∞:', e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–∞—Ä–∫–æ–≤', 'error');
        }
    }

    // --- –ê–î–ú–ò–ù: –ì–†–£–ü–ü–´ –ò –ö–ê–ù–ê–õ–´ ---

    function renderAdminRooms(rooms) {
        const listEl = document.getElementById('admin-rooms-list');
        if (!listEl) return;
        if (!rooms.length) {
            listEl.innerHTML = '<p style="text-align:center; color:#a0aec0;">–ì—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
            return;
        }
        let html = '';
        rooms.forEach(room => {
            const typeLabel = room.type === 'channel' ? '–ö–∞–Ω–∞–ª' : '–ì—Ä—É–ø–ø–∞';
            html += `
                <div style="display:flex; align-items:center; padding:8px 10px; border-radius:10px; background:rgba(15,23,42,0.9); margin-bottom:6px;">
                    <div style="width:32px; height:32px; border-radius:999px; overflow:hidden; background:#1f2937; margin-right:10px; display:flex; align-items:center; justify-content:center; font-size:1.1rem;">
                        ${room.avatarBase64 ? `<img src="${room.avatarBase64}" style="width:100%; height:100%; object-fit:cover;">` : '<i class="fas fa-users"></i>'}
                    </div>
                    <div style="flex-grow:1;">
                        <div style="font-size:0.9rem; font-weight:600; color:#e5e7eb;">${room.name}</div>
                        <div style="font-size:0.75rem; color:#9ca3af;">${typeLabel} ¬∑ —Ä–æ–ª—å: ${room.role}</div>
                    </div>
                </div>
            `;
        });
        listEl.innerHTML = html;
    }

    function openCreateRoomModal() {
        const modal = document.createElement('div');
        modal.id = 'create-room-modal';
        modal.style.cssText = `
            position:fixed; inset:0; background:rgba(0,0,0,0.55);
            z-index:140; display:flex; align-items:center; justify-content:center;
        `;
        modal.innerHTML = `
            <div style="background:#0f172a; color:#e5e7eb; padding:20px; border-radius:20px; max-width:420px; width:90%; box-shadow:0 20px 40px rgba(0,0,0,0.7);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3 style="margin:0;">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É/–∫–∞–Ω–∞–ª</h3>
                    <button onclick="closeCreateRoomModal()" style="background:none; border:none; color:#9ca3af; font-size:1.2rem; cursor:pointer;">‚úï</button>
                </div>
                <label style="font-size:0.85rem;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="room-name-input" type="text" style="width:100%; padding:8px 10px; margin:4px 0 8px; border-radius:10px; border:1px solid #4b5563; background:#020617; color:#e5e7eb;">
                
                <label style="font-size:0.85rem;">–û –≥—Ä—É–ø–ø–µ</label>
                <textarea id="room-about-input" rows="3" style="width:100%; padding:8px 10px; margin:4px 0 8px; border-radius:10px; border:1px solid #4b5563; background:#020617; color:#e5e7eb;"></textarea>

                <label style="font-size:0.85rem; display:block; margin-top:4px;">–ê–≤–∞—Ç–∞—Ä</label>
                <input id="room-avatar-input" type="file" accept="image/*" style="margin:4px 0 8px; color:#9ca3af;">
                
                <button onclick="createRoomFromModal()" style="width:100%; margin-top:8px; padding:9px 0; border:none; border-radius:10px; background:#4f46e5; color:white; font-weight:600; cursor:pointer;">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        `;
        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeCreateRoomModal();
        });
    }

    function closeCreateRoomModal() {
        const modal = document.getElementById('create-room-modal');
        if (modal) modal.remove();
    }

    async function createRoomFromModal() {
        const name = document.getElementById('room-name-input').value.trim();
        const about = document.getElementById('room-about-input').value.trim();
        const fileInput = document.getElementById('room-avatar-input');
        let avatarBase64 = null;

        if (!name) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
            return;
        }

        const sendRequest = async () => {
            try {
                const resp = await fetch(`${API_URL}/api/rooms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        owner_id: currentUser.id,
                        name,
                        type: 'channel',
                        about,
                        avatarBase64
                    })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    showNotification('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω', 'success');
                    closeCreateRoomModal();
                    loadAdminUsers();
                } else {
                    showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', e);
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã', 'error');
            }
        };

        if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                avatarBase64 = e.target.result;
                sendRequest();
            };
            reader.readAsDataURL(file);
        } else {
            await sendRequest();
        }
    }
    function renderAdminGiftsModal(gifts) {
        const modal = document.createElement('div');
        modal.id = 'admin-gifts-modal';
        modal.style.cssText = `
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 110; display:flex; align-items:center; justify-content:center;
        `;

        let html = `
            <div style="background:white; padding:20px; border-radius:24px; max-width:500px; width:90%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">–ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</h3>
                    <button onclick="closeAdminGiftsModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">‚úï</button>
                </div>`;

        if (!gifts.length) {
            html += `<p style="color:#718096; text-align:center; margin:0;">–í—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –ø–æ–¥–∞—Ä–∫–æ–≤.</p>`;
        } else {
            html += `<div id="admin-gifts-list">`;
            gifts.forEach(g => {
                html += `
                    <div style="display:flex; align-items:center; padding:8px 10px; margin-bottom:6px; border-radius:10px; background:rgba(15,23,42,0.9); color:#e5e7eb;">
                        <div style="margin-right:10px; font-size:1.5rem;">${renderGiftVisual(g.image_url)}</div>
                        <div style="flex-grow:1; font-size:0.85rem;">
                            <div style="font-weight:600;">${g.name}</div>
                            <div style="color:#9ca3af;">ID: ${g.id} ¬∑ –¶–µ–Ω–∞: ${g.price} –º–æ–Ω–µ—Ç</div>
                            <div style="color:${g.upgradeable ? '#34d399' : '#f97316'}; font-size:0.78rem; margin-top:2px;">
                                –ê–ø–≥—Ä–µ–π–¥: ${g.upgradeable ? '—Ä–∞–∑—Ä–µ—à–µ–Ω' : '–∑–∞–ø—Ä–µ—â–µ–Ω'}
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <button onclick="toggleGiftUpgradeable('${g.id}', ${g.upgradeable ? 'false' : 'true'})" 
                                    style="background:${g.upgradeable ? '#f97316' : '#10b981'}; color:white; border:none; padding:6px 8px; border-radius:6px; font-size:0.75rem; cursor:pointer;">
                                ${g.upgradeable ? '–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∞–ø–≥—Ä–µ–π–¥' : '–†–∞–∑—Ä–µ—à–∏—Ç—å –∞–ø–≥—Ä–µ–π–¥'}
                            </button>
                            <button onclick="adminCreateNftFromGift('${g.id}')" 
                                    style="background:#6366f1; color:white; border:none; padding:6px 8px; border-radius:6px; font-size:0.75rem; cursor:pointer;">
                                NFT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                            </button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }

        html += `</div>`;
        modal.innerHTML = html;
        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeAdminGiftsModal();
        });
    }

    function closeAdminGiftsModal() {
        const modal = document.getElementById('admin-gifts-modal');
        if (modal) modal.remove();
    }

    async function toggleGiftUpgradeable(giftId, enable) {
        try {
            const response = await fetch(`${API_URL}/api/admin/toggle_gift_upgradeable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_id: currentUser.id,
                    gift_id: giftId,
                    enable: enable
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                closeAdminGiftsModal();
                openAdminGifts();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ toggleGiftUpgradeable:', e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }

    async function adminCreateNftFromGift(giftId) {
        const targetId = prompt('–ö–æ–º—É –≤—ã–¥–∞—Ç—å NFT? –í–≤–µ–¥–∏—Ç–µ @ID –±–µ–∑ @:');
        if (!targetId) return;
        const priceStr = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É NFT –ø–æ–¥–∞—Ä–∫–∞ –¥–ª—è @${targetId} (–≤ –º–æ–Ω–µ—Ç–∞—Ö):`, '100');
        if (!priceStr) return;
        const price = parseInt(priceStr);
        if (isNaN(price) || price <= 0) {
            showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/admin/upgrade_to_nft`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_id: currentUser.id,
                    owner_id: targetId,
                    gift_id: giftId,
                    price: price
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(`NFT –ø–æ–¥–∞—Ä–æ–∫ (${giftId}) –¥–ª—è @${targetId} —Å–æ–∑–¥–∞–Ω!`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NFT –∏–∑ –ø–æ–¥–∞—Ä–∫–∞:', e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ NFT –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }
    // --- –ê–î–ú–ò–ù: –°–û–ó–î–ê–ù–ò–ï NFT –ü–û–î–ê–†–ö–ê –î–õ–Ø –Æ–ó–ï–†–ê ---

    async function adminCreateNftForUser(targetId) {
        const priceStr = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É NFT –ø–æ–¥–∞—Ä–∫–∞ –¥–ª—è @${targetId} (–≤ –º–æ–Ω–µ—Ç–∞—Ö):`, "100");
        if (!priceStr) return;
        const price = parseInt(priceStr);
        if (isNaN(price) || price <= 0) {
            showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/admin/upgrade_to_nft`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_id: currentUser.id,
                    owner_id: targetId,
                    gift_id: 'admin_gift',
                    price: price
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(`NFT –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è @${targetId} —Å–æ–∑–¥–∞–Ω!`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è NFT:', e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ NFT –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }

    // --- GIFTS FUNCTIONALITY ---
    
    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï –ø–æ–¥–∞—Ä–∫–∏ (–¥–ª—è –∫—ç—à–∞ –∏–∫–æ–Ω–æ–∫)
    async function fetchAllGifts() {
        try {
            const response = await fetch(`${API_URL}/api/gifts`);
            const data = await response.json();
            if (data.status === 'success') {
                giftsList = data.gifts;
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                allGiftsMap = {};
                giftsList.forEach(g => {
                    allGiftsMap[g.id] = g;
                });
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤:", error);
        }
    }

    async function openGiftsModal() {
        if (!activeChatPartnerId) {
            showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç!', 'error');
            return;
        }

        selectedGiftId = null;
        document.getElementById('send-gift-button').disabled = true;
        document.getElementById('gifts-balance').innerHTML = `<i class="fas fa-coins"></i> ${currentUser.coins || 0}`;

        await fetchAllGifts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        renderGiftsList();
        document.getElementById('gifts-modal').style.display = 'flex';
    }

    function renderGiftsList() {
        const container = document.getElementById('gifts-container');
        let html = '';

        giftsList.forEach(gift => {
            const canAfford = (currentUser.coins || 0) >= gift.price;
            const isLimited = gift.quantity > 0;
            html += `
                <div class="gift-item ${!canAfford ? 'disabled' : ''}" 
                     onclick="${canAfford ? `selectGift('${gift.id}')` : ''}">
                    <div class="gift-icon-large">${renderGiftVisual(gift.image_url)}</div>
                    <div style="font-weight: 600; margin-bottom: 8px;">${gift.name}</div>
                    <div class="gift-price">${gift.price} –º–æ–Ω–µ—Ç</div>
                    ${gift.is_rare ? '<div style="color: #d69e2e; font-size: 0.8rem; margin-top: 5px;">‚ö° –†–µ–¥–∫–∏–π</div>' : ''}
                    ${isLimited ? `<div style="color: #718096; font-size: 0.7rem; margin-top: 3px;">–û—Å—Ç–∞–ª–æ—Å—å: ${gift.quantity}</div>` : ''}
                    ${!canAfford ? '<div style="color: #e53e3e; font-size: 0.8rem; margin-top: 5px;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç</div>' : ''}
                </div>`;
        });

        container.innerHTML = html;
    }

    function selectGift(giftId) {
        selectedGiftId = giftId;
        
        document.querySelectorAll('.gift-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        const selectedElement = document.querySelector(`.gift-item[onclick*="${giftId}"]`);
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }
        
        document.getElementById('send-gift-button').disabled = false;
    }

    async function sendGift() {
        if (!selectedGiftId || !activeChatPartnerId) return;

        try {
            const response = await fetch(`${API_URL}/api/send_gift`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender_id: currentUser.id,
                    receiver_id: activeChatPartnerId,
                    gift_id: selectedGiftId
                })
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                currentUser.coins = data.new_balance;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                updateCoinsDisplay(data.new_balance);
                
                closeGiftsModal();
                
                await renderMessages(activeChatPartnerId, true);
                
                showNotification(`–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫', 'error');
        }
    }

    function closeGiftsModal() {
        document.getElementById('gifts-modal').style.display = 'none';
        selectedGiftId = null;
    }

    // --- –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–î–ê–†–ö–ê–ú–ò ---

    async function openInventory() {
        try {
            const [invRes, nftRes] = await Promise.all([
                fetch(`${API_URL}/api/inventory/${currentUser.id}`),
                fetch(`${API_URL}/api/nft/my/${currentUser.id}`)
            ]);
            const invData = await invRes.json();
            const nftData = await nftRes.json();
            
            if (invData.status === 'success') {
                myNfts = nftData.status === 'success' ? nftData.items : [];
                showInventoryModal(invData.inventory, myNfts);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è: ' + invData.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å', 'error');
        }
    }

    function showInventoryModal(inventory, nftItems = []) {
        const modal = document.createElement('div');
        modal.id = 'inventory-modal';
        modal.style.cssText = `
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 100; display: flex; align-items: center; justify-content: center;
        `;
        
        let html = `
            <div style="background: white; padding: 25px; border-radius: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
                    <button onclick="closeInventoryModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">‚úï</button>
                </div>`;
        
        if (inventory.length === 0 && nftItems.length === 0) {
            html += `<p style="text-align: center; color: #718096;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>`;
        } else {
            if (inventory.length > 0) {
                html += `<p style="font-weight:600; margin-bottom:8px;">–û–±—ã—á–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</p>`;
            inventory.forEach(item => {
                const sellPrice = item.is_rare ? Math.floor(item.price * 0.8) : Math.floor(item.price * 0.5);
                html += `
                    <div class="inventory-item" style="display: flex; align-items: center; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 10px;">
                        <div style="font-size: 2rem; margin-right: 15px;">${renderGiftVisual(item.image_url)}</div>
                        <div style="flex-grow: 1;">
                            <div style="font-weight: 600;">${item.name}</div>
                            <div style="font-size: 0.9rem; color: #718096;">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}
                                ${item.is_rare ? '<span style="color: #d69e2e; margin-left: 10px;">‚ö° –†–µ–¥–∫–∏–π</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-direction: column;">
                            <button onclick="sellGift('${item.gift_id}', ${item.quantity})" 
                                    style="background: #38a169; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                –ü—Ä–æ–¥–∞—Ç—å (${sellPrice} –º–æ–Ω–µ—Ç)
                            </button>
                            <button onclick="toggleProfileDisplay('${item.gift_id}', ${item.displayed_in_profile})" 
                                    style="background: ${item.displayed_in_profile ? '#e53e3e' : '#3182ce'}; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                ${item.displayed_in_profile ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è' : '–í –ø—Ä–æ—Ñ–∏–ª—å'}
                            </button>
                            ${item.upgradeable ? `
                            <button onclick="upgradeGiftToNft('${item.gift_id}')" 
                                    style="background:#805ad5; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.8rem;">
                                –ê–ø–≥—Ä–µ–π–¥ –≤ NFT
                            </button>` : ''}
                        </div>
                    </div>`;
            });
            }

            if (nftItems.length > 0) {
                html += `<hr style="margin:15px 0; border:none; border-top:1px solid #e2e8f0;">
                         <p style="font-weight:600; margin-bottom:8px;">NFT –ø–æ–¥–∞—Ä–∫–∏</p>
                         <div style="display:flex; flex-wrap:wrap; gap:10px;">`;
                nftItems.forEach(nft => {
                    html += `
                        <div class="nft-card" style="background:${getNftBackground(nft.bg_variant)};" 
                             onclick="showNftInfo('${nft.token_id}')">
                            <div class="nft-image-wrapper">
                                ${renderGiftVisual(nft.image_url)}
                            </div>
                            <div class="nft-meta">
                                #${nft.serial_number} ‚Ä¢ ${nft.name}<br>
                                –í–ª–∞–¥–µ–ª–µ—Ü: @${nft.owner_id}<br>
                                –¶–µ–Ω–∞: ${nft.price} –º–æ–Ω–µ—Ç
                            </div>
                            <div class="nft-actions">
                                <button onclick="event.stopPropagation(); toggleNftMarket('${nft.token_id}', ${nft.is_listed ? 'false' : 'true'}, ${nft.price})" 
                                        style="background:#3182ce; color:white;">
                                    ${nft.is_listed ? '–°–Ω—è—Ç—å —Å –º–∞—Ä–∫–µ—Ç–∞' : '–ù–∞ –º–∞—Ä–∫–µ—Ç'}
                                </button>
                                <button onclick="event.stopPropagation(); regiftNft('${nft.token_id}')" 
                                        style="background:#d69e2e; color:white;">
                                    –ü–æ–¥–∞—Ä–∏—Ç—å –∑–∞ 25‚≠ê
                                </button>
                                <button onclick="event.stopPropagation(); toggleNftProfileDisplay('${nft.token_id}', ${nft.displayed_in_profile})" 
                                        style="background:${nft.displayed_in_profile ? '#e53e3e' : '#10b981'}; color:white;">
                                    ${nft.displayed_in_profile ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è' : '–í –ø—Ä–æ—Ñ–∏–ª—å'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
        }
        
        html += `</div>`;
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeInventoryModal();
            }
        });
    }

    function closeInventoryModal() {
        const modal = document.getElementById('inventory-modal');
        if (modal) {
            modal.remove();
        }
    }

    function showNftInfo(tokenId) {
        const nft = (myNfts || []).find(n => n.token_id === tokenId) || (nftMarket || []).find(n => n.token_id === tokenId);
        if (!nft) return;
        const info = `NFT #${nft.serial_number}\n` +
                     `–ü–æ–¥–∞—Ä–æ–∫: ${nft.name}\n` +
                     `–ö—Ç–æ –ø–æ–¥–∞—Ä–∏–ª (—Å–æ–∑–¥–∞–ª): @${nft.original_sender_id || nft.creator_admin_id || 'admin'}\n` +
                     `–¢–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü: @${nft.owner_id}\n` +
                     `–¶–µ–Ω–∞: ${nft.price} –º–æ–Ω–µ—Ç\n` +
                     `–°–æ–∑–¥–∞–Ω: ${nft.created_at || ''}`;
        alert(info);
    }

    async function toggleNftMarket(tokenId, list, currentPrice) {
        let price = currentPrice;
        if (list) {
            const input = prompt('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ NFT (–≤ –º–æ–Ω–µ—Ç–∞—Ö):', price && price > 0 ? price : '100');
            if (!input) return;
            price = parseInt(input);
            if (isNaN(price) || price <= 0) {
                showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞', 'error');
                return;
            }
        }
        try {
            const response = await fetch(`${API_URL}/api/nft/list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    token_id: tokenId,
                    is_listed: list,
                    price: price
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                closeInventoryModal();
                openInventory();
                loadMarket();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error(e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ NFT', 'error');
        }
    }

    async function regiftNft(tokenId) {
        const toUser = prompt('–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å NFT? –í–≤–µ–¥–∏—Ç–µ @ID –±–µ–∑ @:');
        if (!toUser) return;
        try {
            const response = await fetch(`${API_URL}/api/nft/regift`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    from_user: currentUser.id,
                    to_user: toUser,
                    token_id: tokenId
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                currentUser.coins = data.new_balance;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                updateCoinsDisplay(data.new_balance);
                showNotification('NFT —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞—Ä–µ–Ω –∑–∞ 25‚≠ê', 'success');
                closeInventoryModal();
                openInventory();
                loadMarket();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error(e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—Ä–∏–≤–∞–Ω–∏–∏ NFT', 'error');
        }
    }

    async function loadMarket() {
        try {
            const response = await fetch(`${API_URL}/api/nft/market`);
            const data = await response.json();
            if (data.status === 'success') {
                nftMarket = data.items || [];
                renderMarket();
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞:', e);
        }
    }

    function renderMarket() {
        const container = document.getElementById('market-list');
        if (!container) return;
        if (!nftMarket || nftMarket.length === 0) {
            container.innerHTML = '<p style="color:#718096;">–ü–æ–∫–∞ –Ω–µ—Ç NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ.</p>';
            return;
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –±–∞–∑–æ–≤–æ–º—É –ø–æ–¥–∞—Ä–∫—É
        const groups = {};
        nftMarket.forEach(nft => {
            const key = nft.base_gift_id;
            if (!groups[key]) {
                groups[key] = { name: nft.name, image_url: nft.image_url, items: [] };
            }
            groups[key].items.push(nft);
        });

        let html = '';
        Object.keys(groups).forEach(giftId => {
            const group = groups[giftId];
            const count = group.items.length;
            const minPrice = Math.min(...group.items.map(i => i.price));
            html += `
                <div style="display:flex; align-items:center; padding:10px 12px; border-radius:14px; background:#f8fafc; margin-bottom:10px;">
                    <div class="nft-image-wrapper" style="margin-bottom:0; margin-right:12px; background:#fff;">
                        ${renderGiftVisual(group.image_url)}
                    </div>
                    <div style="flex-grow:1;">
                        <div style="font-weight:600;">${group.name}</div>
                        <div style="font-size:0.8rem; color:#718096;">NFT: ${count} ¬∑ –æ—Ç ${minPrice} –º–æ–Ω–µ—Ç</div>
                    </div>
                    <button onclick="openGiftMarket('${giftId}')" 
                            style="background:#3182ce; color:white; border:none; padding:8px 12px; border-radius:8px; font-size:0.8rem; cursor:pointer;">
                        –û—Ç–∫—Ä—ã—Ç—å
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    async function buyNft(tokenId, price) {
        if (!confirm(`–ö—É–ø–∏—Ç—å —ç—Ç–æ—Ç NFT –∑–∞ ${price} –º–æ–Ω–µ—Ç?`)) return;
        try {
            const response = await fetch(`${API_URL}/api/nft/buy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    buyer_id: currentUser.id,
                    token_id: tokenId
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                currentUser.coins = data.new_balance;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                updateCoinsDisplay(data.new_balance);
                showNotification('NFT –∫—É–ø–ª–µ–Ω!', 'success');
                loadMarket();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error(e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT', 'error');
        }
    }

    function openGiftMarket(baseGiftId) {
        const items = (nftMarket || []).filter(n => n.base_gift_id === baseGiftId);
        if (!items.length) return;

        const modal = document.createElement('div');
        modal.id = 'gift-market-modal';
        modal.style.cssText = `
            position:fixed; inset:0; background:rgba(0,0,0,0.55);
            z-index:120; display:flex; align-items:center; justify-content:center;
        `;

        const name = items[0].name;

        let html = `
            <div style="background:white; padding:20px; border-radius:24px; max-width:640px; width:94%; max-height:80vh; overflow-y:auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3 style="margin:0;">${name} ¬∑ NFT</h3>
                    <button onclick="closeGiftMarketModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">‚úï</button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:12px;">`;

        items.forEach(nft => {
            html += `
                <div class="nft-card" style="background:${getNftBackground(nft.bg_variant)};" onclick="showNftInfo('${nft.token_id}')">
                    <div class="nft-image-wrapper">
                        ${renderGiftVisual(nft.image_url)}
                    </div>
                    <div class="nft-meta">
                        #${nft.serial_number} ¬∑ –ü—Ä–æ–¥–∞–≤–µ—Ü: @${nft.owner_id}<br>
                        –¶–µ–Ω–∞: ${nft.price} –º–æ–Ω–µ—Ç
                    </div>
                    <div class="nft-actions">
                        <button onclick="event.stopPropagation(); buyNft('${nft.token_id}', ${nft.price})" 
                                style="background:#38a169; color:white;">
                            –ö—É–ø–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
        });

        html += `</div></div>`;
        modal.innerHTML = html;
        document.body.appendChild(modal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeGiftMarketModal();
        });
    }

    function closeGiftMarketModal() {
        const modal = document.getElementById('gift-market-modal');
        if (modal) modal.remove();
    }

    async function sellGift(giftId, maxQuantity) {
        const quantity = prompt(`–°–∫–æ–ª—å–∫–æ –ø–æ–¥–∞—Ä–∫–æ–≤ –ø—Ä–æ–¥–∞—Ç—å? (–ú–∞–∫—Å–∏–º—É–º: ${maxQuantity})`, "1");
        if (!quantity || isNaN(quantity) || quantity <= 0 || quantity > maxQuantity) {
            showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/api/sell_gift`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    gift_id: giftId,
                    quantity: parseInt(quantity)
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                currentUser.coins = data.new_balance;
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                updateCoinsDisplay(data.new_balance);
                closeInventoryModal();
                openInventory();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫', 'error');
        }
    }

    async function upgradeGiftToNft(giftId) {
        const priceStr = prompt('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É NFT (–≤ –º–æ–Ω–µ—Ç–∞—Ö):', '100');
        if (!priceStr) return;
        const price = parseInt(priceStr);
        if (isNaN(price) || price <= 0) {
            showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/api/nft/upgrade`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    gift_id: giftId,
                    price: price
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification('–ü–æ–¥–∞—Ä–æ–∫ –∞–ø–≥—Ä–µ–π–∂–µ–Ω –≤ NFT!', 'success');
                closeInventoryModal();
                openInventory();
                loadMarket();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞ –≤ NFT:', e);
            showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∞–ø–≥—Ä–µ–π–¥–µ –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }

    async function toggleNftProfileDisplay(tokenId, currentlyDisplayed) {
        try {
            const response = await fetch(`${API_URL}/api/toggle_nft_profile_display`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    token_id: tokenId
                })
            });
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                closeInventoryModal();
                openInventory();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ toggleNftProfileDisplay:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ NFT', 'error');
        }
    }

    async function toggleProfileDisplay(giftId, currentlyDisplayed) {
        try {
            const response = await fetch(`${API_URL}/api/toggle_profile_display`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    gift_id: giftId
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                closeInventoryModal();
                openInventory();
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞', 'error');
        }
    }

    // --- –ê–î–ú–ò–ù: –°–û–ó–î–ê–ù–ò–ï –ü–û–î–ê–†–ö–û–í (–û–ë–ù–û–í–õ–ï–ù–û) ---
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    async function handleGiftFileSelect(input) {
        const file = input.files[0];
        const previewEl = document.getElementById('new-gift-preview');
        const textInput = document.getElementById('new-gift-image');
        
        if (file) {
            previewEl.innerHTML = '<span style="color:#718096">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>';
            try {
                // –°–∂–∏–º–∞–µ–º –¥–æ 100x100 (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∏–∫–æ–Ω–∫–∏)
                const base64 = await resizeImage(file, 100, 100);
                newGiftImageBase64 = base64;
                previewEl.innerHTML = `<img src="${base64}" style="width: 50px; height: 50px; object-fit: contain;">`;
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª
                textInput.value = ''; 
                textInput.disabled = true;
                textInput.placeholder = "(–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª)";
            } catch (e) {
                console.error(e);
                previewEl.innerHTML = '<span style="color:red">–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞</span>';
                newGiftImageBase64 = null;
            }
        } else {
            newGiftImageBase64 = null;
            previewEl.innerHTML = '';
            textInput.disabled = false;
            textInput.placeholder = "üéÅ –∏–ª–∏ URL";
        }
    }

    async function openCreateGiftModal() {
        newGiftImageBase64 = null; // –°–±—Ä–æ—Å
        
        const modal = document.createElement('div');
        modal.id = 'create-gift-modal';
        modal.style.cssText = `
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 100; display: flex; align-items: center; justify-content: center;
        `;
        
        const html = `
            <div style="background: white; padding: 25px; border-radius: 24px; max-width: 400px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h3>
                    <button onclick="closeCreateGiftModal()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">‚úï</button>
                </div>
                
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="new-gift-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                
                <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Ñ–∞–π–ª):</label>
                <input type="file" id="new-gift-file" accept="image/*" onchange="handleGiftFileSelect(this)" style="width: 100%; margin-bottom: 5px;">
                <div id="new-gift-preview" style="text-align: center; margin-bottom: 10px;"></div>
                
                <label>–ò–ª–∏ —ç–º–æ–¥–∑–∏/—Å—Å—ã–ª–∫–∞ (—Ç–µ–∫—Å—Ç):</label>
                <input type="text" id="new-gift-image" placeholder="üéÅ –∏–ª–∏ URL" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                
                <label>–¶–µ–Ω–∞:</label>
                <input type="number" id="new-gift-price" placeholder="100" min="1" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0;">
                
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (0 = –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ):</label>
                <input type="number" id="new-gift-quantity" placeholder="0" min="0" style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                
                <label style="display: flex; align-items: center; margin-bottom: 15px;">
                    <input type="checkbox" id="new-gift-rare" style="margin-right: 8px;">
                    –†–µ–¥–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ ‚ö°
                </label>
                <label style="display: flex; align-items: center; margin-bottom: 15px;">
                    <input type="checkbox" id="new-gift-upgradeable" style="margin-right: 8px;">
                    –ú–æ–∂–Ω–æ –∞–ø–≥—Ä–µ–π–¥–∏—Ç—å –≤ NFT
                </label>
                
                <button onclick="createNewGift()" style="width: 100%; padding: 12px; background: #d69e2e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫
                </button>
            </div>`;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeCreateGiftModal();
            }
        });
    }

    function closeCreateGiftModal() {
        const modal = document.getElementById('create-gift-modal');
        if (modal) {
            modal.remove();
        }
    }

    async function createNewGift() {
        const name = document.getElementById('new-gift-name').value;
        // –ë–µ—Ä–µ–º –ª–∏–±–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –ª–∏–±–æ —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è
        const image_url = newGiftImageBase64 || document.getElementById('new-gift-image').value;
        const price = parseInt(document.getElementById('new-gift-price').value);
        const quantity = parseInt(document.getElementById('new-gift-quantity').value) || 0;
        const is_rare = document.getElementById('new-gift-rare').checked;
        const upgradeable = document.getElementById('new-gift-upgradeable').checked;
        
        if (!name || !image_url || !price || price < 1) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–∞—Ä—Ç–∏–Ω–∫–∞, —Ü–µ–Ω–∞)', 'error');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/api/admin/create_gift`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_id: currentUser.id,
                    name: name,
                    image_url: image_url,
                    price: price,
                    quantity: quantity === 0 ? -1 : quantity,
                    is_rare: is_rare,
                    upgradeable: upgradeable
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                showNotification('–ü–æ–¥–∞—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                closeCreateGiftModal();
                await fetchAllGifts(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ
            } else {
                showNotification('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫', 'error');
        }
    }

    // --- INIT ---
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    window.onload = () => {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ –∑–∞–∫—Ä—ã—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        const callModal = document.getElementById('call-modal');
        if (callModal) {
            callModal.style.display = 'none';
            callModal.style.setProperty('display', 'none', 'important');
        }
        
        const storedUser = localStorage.getItem('vault_user');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            initializeApp();
        } else {
            document.getElementById('auth-view').style.display = 'block';
        }

        // –¢–µ–º–∞
        const theme = getSetting('theme', 'dark');
        const themeCheckbox = document.getElementById('setting-theme');
        if (themeCheckbox) {
            themeCheckbox.checked = theme === 'dark';
        }
        applyTheme();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ UI
        const soundsCheckbox = document.getElementById('setting-sounds');
        const compactCheckbox = document.getElementById('setting-compact');
        const statusCheckbox = document.getElementById('setting-status');

        if (soundsCheckbox) soundsCheckbox.checked = getSetting('sounds', true);
        if (compactCheckbox) compactCheckbox.checked = getSetting('compact', false);
        if (statusCheckbox) statusCheckbox.checked = getSetting('status', true);

        if (themeCheckbox) {
            themeCheckbox.addEventListener('change', (e) => {
                setSetting('theme', e.target.checked ? 'dark' : 'light');
                applyTheme();
            });
        }
        if (soundsCheckbox) soundsCheckbox.addEventListener('change', (e) => setSetting('sounds', e.target.checked));
        if (compactCheckbox) compactCheckbox.addEventListener('change', (e) => setSetting('compact', e.target.checked));
        if (statusCheckbox) statusCheckbox.addEventListener('change', (e) => setSetting('status', e.target.checked));

        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞—É–¥–∏–æ –Ω–∞ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
        document.body.addEventListener('click', () => {
            try {
                messageSound.play().then(() => {
                    messageSound.pause();
                    messageSound.currentTime = 0;
                }).catch(() => {});
            } catch (e) {}
        }, { once: true });

        document.getElementById('close-profile-modal').addEventListener('click', closeProfileModal);
        document.getElementById('profile-modal').addEventListener('click', (e) => {
            if (e.target.id === 'profile-modal') {
                closeProfileModal();
            }
        });

        document.getElementById('close-gifts-modal').addEventListener('click', closeGiftsModal);
        document.getElementById('gifts-modal').addEventListener('click', (e) => {
            if (e.target.id === 'gifts-modal') {
                closeGiftsModal();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–≤–æ–Ω–∫–∞
        document.getElementById('call-modal').addEventListener('click', (e) => {
            if (e.target.id === 'call-modal') {
                endCall();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ initializeApp()
    };

    // --- VIDEO CALLS (WebRTC) ---
    
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let currentCallId = null;
    let isCaller = false;
    let isMuted = false;
    let isVideoEnabled = true;
    let callPollingInterval = null;

    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };

    async function startCall() {
        if (!activeChatPartnerId || activeChatIsChannel) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
            return;
        }

        if (currentCallId) {
            showNotification('–£–∂–µ –∏–¥–µ—Ç –∑–≤–æ–Ω–æ–∫', 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏', 'error');
            return;
        }

        try {
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const constraints = {
                video: false,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (–∞—É–¥–∏–æ)
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // –í–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            isVideoEnabled = false;
            document.getElementById('video-btn').style.background = '#ef4444';
            document.getElementById('video-btn').innerHTML = '<i class="fas fa-video-slash"></i>';
            
            const localVideo = document.getElementById('local-video');
            localVideo.srcObject = localStream;
            localVideo.muted = true; // –í–∞–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ–ø–ª–µ—è
            localVideo.setAttribute('playsinline', 'true'); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            localVideo.setAttribute('webkit-playsinline', 'true'); // –î–ª—è iOS
            const callModal = document.getElementById('call-modal');
            callModal.style.display = 'flex';
            callModal.style.setProperty('display', 'flex', 'important');
            document.getElementById('remote-user-name').textContent = activeChatPartnerName || activeChatPartnerId;
            document.getElementById('call-status').textContent = '–ó–≤–æ–Ω–æ–∫...';
            
            isCaller = true;
            currentCallId = `${currentUser.id}_${activeChatPartnerId}`;
            
            // –°–æ–∑–¥–∞–µ–º peer connection
            peerConnection = new RTCPeerConnection(configuration);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ —Ç—Ä–µ–∫ (–≤–∏–¥–µ–æ –¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–º)
            localStream.getAudioTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.setAttribute('playsinline', 'true'); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                remoteVideo.setAttribute('webkit-playsinline', 'true'); // –î–ª—è iOS
                remoteVideo.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ:', e));
                document.getElementById('call-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendIceCandidate(event.candidate);
                }
            };
            
            // –°–æ–∑–¥–∞–µ–º offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(`${API_URL}/api/calls`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'offer',
                    caller_id: currentUser.id,
                    callee_id: activeChatPartnerId,
                    offer: offer
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                // –ù–∞—á–∏–Ω–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è answer –∏ ICE candidates
                startCallPolling();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞: ' + data.message, 'error');
                endCall();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
            let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMsg = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞. –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
            } else if (error.name === 'OverconstrainedError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
            } else if (error.name === 'TypeError') {
                errorMsg = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.';
            }
            
            showNotification(errorMsg, 'error');
            endCall();
        }
    }

    async function checkIncomingCalls() {
        // –°—Ç—Ä–æ–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–≤–æ–Ω–∫–æ–≤
        if (!currentUser || !currentUser.id) {
            return; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        }
        
        if (currentCallId) {
            return; // –£–∂–µ –≤ –∑–≤–æ–Ω–∫–µ
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        const appEl = document.getElementById('app');
        const authEl = document.getElementById('auth-view');
        if (!appEl || appEl.style.display === 'none' || 
            (authEl && authEl.style.display !== 'none')) {
            return; // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ –∑–∞–∫—Ä—ã—Ç–æ
        const callModal = document.getElementById('call-modal');
        if (callModal && callModal.style.display !== 'none') {
            return; // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ
        }
        
        try {
            const response = await fetch(`${API_URL}/api/calls`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'check_incoming',
                    user_id: currentUser.id
                })
            });
            
            const data = await response.json();
            if (data.status === 'success' && data.calls && data.calls.length > 0) {
                const call = data.calls[0];
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∑–≤–æ–Ω–∫–∞
                if (!currentCallId && callModal && callModal.style.display === 'none') {
                    handleIncomingCall(call.call_id, call.caller_id, call.offer);
                }
            }
        } catch (error) {
            // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤:', error);
        }
    }

    async function handleIncomingCall(callId, callerId, offer) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–µ –≤ –¥—Ä—É–≥–æ–º –∑–≤–æ–Ω–∫–µ
        if (currentCallId) {
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
        const accept = confirm(`–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç @${callerId}\n\n–ü—Ä–∏–Ω—è—Ç—å?`);
        
        if (!accept) {
            // –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫
            try {
                await fetch(`${API_URL}/api/calls`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'end_call',
                        call_id: callId
                    })
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', e);
            }
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏', 'error');
            return;
        }
        
        try {
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const constraints = {
                video: false,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (–≤–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // –í–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            isVideoEnabled = false;
            document.getElementById('video-btn').style.background = '#ef4444';
            document.getElementById('video-btn').innerHTML = '<i class="fas fa-video-slash"></i>';
            
            const localVideo = document.getElementById('local-video');
            localVideo.srcObject = localStream;
            localVideo.muted = true; // –í–∞–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ–ø–ª–µ—è
            localVideo.setAttribute('playsinline', 'true'); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            localVideo.setAttribute('webkit-playsinline', 'true'); // –î–ª—è iOS
            const callModal = document.getElementById('call-modal');
            callModal.style.display = 'flex';
            callModal.style.setProperty('display', 'flex', 'important');
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∑–≤–æ–Ω—è—â–µ–≥–æ
            try {
                const userResp = await fetch(`${API_URL}/api/user/${callerId}`);
                const userData = await userResp.json();
                if (userData.status === 'success') {
                    document.getElementById('remote-user-name').textContent = userData.user.displayName || callerId;
                } else {
                    document.getElementById('remote-user-name').textContent = '@' + callerId;
                }
            } catch (e) {
                document.getElementById('remote-user-name').textContent = '@' + callerId;
            }
            
            document.getElementById('call-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            
            isCaller = false;
            currentCallId = callId;
            
            // –°–æ–∑–¥–∞–µ–º peer connection
            peerConnection = new RTCPeerConnection(configuration);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ —Ç—Ä–µ–∫
            localStream.getAudioTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = remoteStream;
                remoteVideo.setAttribute('playsinline', 'true'); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                remoteVideo.setAttribute('webkit-playsinline', 'true'); // –î–ª—è iOS
                remoteVideo.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ:', e));
                document.getElementById('call-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendIceCandidate(event.candidate);
                }
            };
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π offer
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            // –°–æ–∑–¥–∞–µ–º answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(`${API_URL}/api/calls`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'answer',
                    call_id: callId,
                    answer: answer
                })
            });
            
            if (response.ok) {
                // –ù–∞—á–∏–Ω–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ICE candidates
                startCallPolling();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞', 'error');
                endCall();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', error);
            let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMsg = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞. –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
            } else if (error.name === 'OverconstrainedError') {
                errorMsg = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
            } else if (error.name === 'TypeError') {
                errorMsg = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.';
            }
            
            showNotification(errorMsg, 'error');
            endCall();
        }
    }

    function startCallPolling() {
        if (callPollingInterval) clearInterval(callPollingInterval);
        
        callPollingInterval = setInterval(async () => {
            if (!currentCallId) {
                clearInterval(callPollingInterval);
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/calls`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_call',
                        call_id: currentCallId,
                        user_id: currentUser.id
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success' && data.call) {
                    const call = data.call;
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º answer (–¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞)
                    if (isCaller && call.answer && peerConnection.remoteDescription === null) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(call.answer));
                    }
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º offer (–¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è - —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    if (!isCaller && call.offer && peerConnection.remoteDescription === null) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(call.offer));
                    }
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ICE candidates
                    if (call.ice_candidates && call.ice_candidates.length > 0) {
                        for (const candidate of call.ice_candidates) {
                            try {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            } catch (e) {
                                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE candidate:', e);
                            }
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
                    if (call.status === 'ended') {
                        endCall();
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ polling –∑–≤–æ–Ω–∫–∞:', error);
            }
        }, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    }

    async function sendIceCandidate(candidate) {
        if (!currentCallId) return;
        
        try {
            await fetch(`${API_URL}/api/calls`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'ice_candidate',
                    call_id: currentCallId,
                    user_id: currentUser.id,
                    candidate: candidate
                })
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ICE candidate:', error);
        }
    }

    function toggleMute() {
        if (!localStream) return;
        
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !isMuted;
        });
        
        const btn = document.getElementById('mute-btn');
        if (isMuted) {
            btn.style.background = '#ef4444';
            btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
        } else {
            btn.style.background = '#4f46e5';
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
        }
    }

    async function toggleVideo() {
        if (!localStream) return;
        
        const btn = document.getElementById('video-btn');
        
        if (!isVideoEnabled) {
            // –í–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
            try {
                // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const videoConstraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
                    },
                    audio: false
                };
                
                const videoStream = await navigator.mediaDevices.getUserMedia(videoConstraints);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–æ—Ç–æ–∫—É
                videoStream.getVideoTracks().forEach(track => {
                    localStream.addTrack(track);
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫ –≤ peer connection
                    if (peerConnection) {
                        peerConnection.addTrack(track, localStream);
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
                document.getElementById('local-video').srcObject = localStream;
                
                isVideoEnabled = true;
                btn.style.background = '#4f46e5';
                btn.innerHTML = '<i class="fas fa-video"></i>';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
                let errorMsg = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMsg = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞. –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ HTTPS.';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMsg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMsg = '–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMsg = '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
                }
                
                showNotification(errorMsg, 'error');
            }
        } else {
            // –í—ã–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ
            localStream.getVideoTracks().forEach(track => {
                track.stop();
                localStream.removeTrack(track);
                // –£–¥–∞–ª—è–µ–º —Ç—Ä–µ–∫ –∏–∑ peer connection
                if (peerConnection) {
                    const sender = peerConnection.getSenders().find(s => s.track === track);
                    if (sender) {
                        peerConnection.removeTrack(sender);
                    }
                }
            });
            
            isVideoEnabled = false;
            btn.style.background = '#ef4444';
            btn.innerHTML = '<i class="fas fa-video-slash"></i>';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
            document.getElementById('local-video').srcObject = localStream;
        }
    }

    async function endCall() {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø–æ—Ç–æ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º peer connection
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        
        // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
        document.getElementById('local-video').srcObject = null;
        document.getElementById('remote-video').srcObject = null;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const callModal = document.getElementById('call-modal');
        callModal.style.display = 'none';
        callModal.style.setProperty('display', 'none', 'important');
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
        if (currentCallId) {
            try {
                await fetch(`${API_URL}/api/calls`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'end_call',
                        call_id: currentCallId
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', error);
            }
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling
        if (callPollingInterval) {
            clearInterval(callPollingInterval);
            callPollingInterval = null;
        }
        
        currentCallId = null;
        isCaller = false;
        isMuted = false;
        isVideoEnabled = true;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('mute-btn').style.background = '#4f46e5';
        document.getElementById('mute-btn').innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('video-btn').style.background = '#4f46e5';
        document.getElementById('video-btn').innerHTML = '<i class="fas fa-video"></i>';
    }
</script>
</body>
</html>