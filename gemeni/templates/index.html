
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #6a67ce;
            --accent-hover: #5653b0;
            --sidebar-bg: #ffffff;
            --chat-bg: #f0f2f5;
            --text-main: #2d3748;
            --text-secondary: #718096;
            --danger: #e53e3e;
            --success: #38a169;
            --radius-main: 24px;
            --radius-elem: 12px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: #dfe9f3;
            background-image: var(--primary-gradient);
            background-size: cover;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            overflow: hidden;
        }

        /* Скроллбар */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

        .hidden { display: none !important; }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ЭКРАН ВХОДА --- */
        #auth-view {
            padding: 50px 40px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-main);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
        }
        #auth-view h2 { margin-bottom: 30px; color: #4a5568; }
        
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 14px 18px;
            margin: 8px 0;
            border-radius: var(--radius-elem);
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            font-size: 1rem;
            transition: 0.3s;
            font-family: inherit;
        }
        input:focus, textarea:focus {
            border-color: var(--accent-color);
            background: #fff;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 15px;
            border: none;
            border-radius: var(--radius-elem);
            background: var(--accent-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background: var(--accent-hover); transform: translateY(-2px); }
        #register-button { background: transparent; color: var(--text-secondary); margin-top: 5px; }
        #register-button:hover { color: var(--accent-color); background: rgba(106, 103, 206, 0.1); transform: none; }

        /* --- ГЛАВНОЕ ОКНО --- */
        #app {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: #fff;
            border-radius: var(--radius-main);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
            position: relative;
        }

        /* --- БОКОВОЕ МЕНЮ (SIDEBAR) --- */
        #sidebar {
            width: 350px;
            min-width: 350px; 
            background: var(--sidebar-bg);
            border-right: 1px solid #edf2f7;
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        .tabs {
            display: flex;
            padding: 15px;
            background: #fff;
            gap: 10px;
            border-bottom: 1px solid #edf2f7;
        }
        .tab-button {
            background: transparent;
            color: #a0aec0;
            padding: 10px;
            flex: 1;
            font-size: 1.1rem;
            box-shadow: none;
            margin: 0;
        }
        .tab-button:hover { background: #f7fafc; color: var(--accent-color); transform: none; }
        .tab-button.active { background: rgba(106, 103, 206, 0.1); color: var(--accent-color); }
        .tab-button:last-child:hover { color: var(--danger); background: rgba(229, 62, 62, 0.1); transform: none; }
        .admin-tab-button { color: #d69e2e !important; }

        .chat-list, .search-list {
            list-style: none;
            padding: 10px;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        .chat-item, .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 5px;
            border-radius: var(--radius-elem);
            cursor: pointer;
            transition: 0.2s;
        }
        .chat-item:hover, .user-item:hover { background-color: #f7fafc; transform: translateX(3px); }
        .chat-item.active { background-color: var(--accent-color); color: white; }
        .chat-item.active .name { color: white; }
        .chat-item.active .last-message { color: rgba(255,255,255,0.8); }

        .avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background: #cbd5e0;
            flex-shrink: 0;
        }
        .details { flex-grow: 1; overflow: hidden; }
        .name { font-weight: 600; margin-bottom: 2px; }
        .last-message { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- ПОИСК И АДМИНКА --- */
        #search-tab, #admin-tab { padding: 20px; background: white; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .search-bar {
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            width: 100%;
            background: #f8fafc;
        }

        /* --- ЧАТ (MAIN CONTENT) --- */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
            position: relative;
            min-width: 0;
        }
        
        .header {
            padding: 15px 25px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            font-weight: 600;
            z-index: 5;
            height: 70px;
        }
        
        .back-button {
            display: none;
            margin-right: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* КОНТЕЙНЕР СООБЩЕНИЙ */
        #messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex; 
            flex-direction: column; 
            gap: 10px;
        }
        
        .message-row { display: flex; align-items: flex-end; margin-bottom: 5px; animation: fadeIn 0.3s; }
        .message-row .avatar { width: 32px; height: 32px; margin-bottom: 5px; }
        
        .message {
            padding: 12px 16px;
            max-width: 70%;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word; 
        }
        
        .received { align-self: flex-start; }
        .received .message { background: white; border-radius: 18px 18px 18px 2px; margin-left: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .received .avatar { margin-right: 5px; }

        .sent { align-self: flex-end; justify-content: flex-end; }
        .sent .message { background: var(--primary-gradient); color: white; border-radius: 18px 18px 2px 18px; margin-right: 5px; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4); }
        .sent .avatar { margin-left: 5px; }

        .message-info { display: block; margin-top: 4px; font-size: 0.7rem; opacity: 0.7; text-align: right; }

        #input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #message-input { margin: 0; border-radius: 25px; padding-left: 20px; }
        #send-button { width: 50px; height: 50px; border-radius: 50%; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; }

        /* --- АДМИНКА --- */
        #admin-user-list { overflow-y: auto; flex-grow: 1; }
        .admin-user-card {
            background: #f8fafc;
            border-left: 4px solid #d69e2e;
            padding: 15px;
            border-radius: var(--radius-elem);
            margin-bottom: 10px;
        }
        .admin-actions { display: flex; gap: 10px; margin-top: 10px; }
        .admin-actions button { width: auto; margin: 0; padding: 6px 12px; font-size: 0.85rem; box-shadow: none; }
        .admin-save-btn { background: var(--success); }
        .admin-ban-btn { background: var(--danger); }
        .admin-unban-btn { background: #3182ce; }
        
        /* Стили для МОДАЛЬНОГО ОКНА ПРОФИЛЯ */
        #profile-modal {
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.5); 
            z-index: 100; 
            display: none; 
            align-items: center; 
            justify-content: center;
        }
        #profile-modal > div {
            background: white; 
            padding: 25px; 
            border-radius: var(--radius-main); 
            max-width: 380px; 
            width: 90%; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); 
            position: relative;
        }

        /* --- АДАПТИВНОСТЬ (MOBILE) --- */
        @media (max-width: 850px) {
            #app { width: 100%; height: 100vh; border-radius: 0; }
            #sidebar { width: 100%; position: absolute; height: 100%; top: 0; left: 0; }
            #main-content { width: 100%; position: absolute; height: 100%; top: 0; left: 0; transform: translateX(100%); transition: transform 0.3s ease; z-index: 20; }
            
            body.chat-active #main-content { transform: translateX(0); }
            body.chat-active #sidebar { transform: translateX(-20%); opacity: 0; pointer-events: none; }
            
            .back-button { display: block; }
        }
    </style>
</head>
<body>
    <div id="auth-view" style="display: none;">
        <h2><i class="fas fa-shield-alt"></i> Vault Messenger</h2>
        <input type="text" id="auth-username" placeholder="Логин (ID)">
        <input type="password" id="auth-password" placeholder="Пароль">
        <input type="text" id="auth-display-name" placeholder="Ваше имя" style="display:none;">
        
        <button id="login-button" onclick="handleLogin()">Войти</button>
        <button id="register-button" onclick="showRegister()">Создать аккаунт</button>
        <p id="auth-message"></p>
    </div>

    <div id="app" style="display: none;">
        <div id="sidebar">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('chats')" title="Чаты"><i class="fas fa-comments"></i></button>
                <button class="tab-button" onclick="showTab('search')" title="Поиск"><i class="fas fa-search"></i></button>
                <button class="tab-button" onclick="showTab('profile')" title="Профиль"><i class="fas fa-user-circle"></i></button>
                <button id="admin-tab-button" class="tab-button admin-tab-button hidden" onclick="showTab('admin')" title="Админ"><i class="fas fa-user-shield"></i></button>
                <button class="tab-button" onclick="logout()" title="Выход"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            
            <ul id="chats-tab" class="chat-list"></ul>
            
            <div id="search-tab" class="hidden">
                <input type="text" class="search-bar" id="search-input" placeholder="Поиск @ID..." onkeyup="handleSearch()">
                <ul id="search-list" class="search-list"></ul>
            </div>

            <div id="profile-tab" class="profile-view hidden">
                <img id="profile-avatar" class="avatar" src="" alt="Аватар">
                <div style="text-align:center; margin-bottom:20px;">
                    <label for="avatar-input" style="cursor:pointer; color:var(--accent-color); font-weight:600;">
                        <i class="fas fa-camera"></i> Сменить фото
                    </label>
                    <input type="file" id="avatar-input" accept="image/*" style="display:none;" onchange="previewAvatar(this)">
                </div>
                <h3 id="profile-username-display" style="text-align:center; color:#718096; margin-top:0;"></h3>
                <label>Имя:</label>
                <input type="text" id="edit-display-name">
                <label>О себе:</label>
                <textarea id="edit-bio" rows="3"></textarea>
                <button onclick="saveProfileChanges()"><i class="fas fa-save"></i> Сохранить</button>
            </div>
            
            <div id="admin-tab" class="hidden">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0;">Управление</h3>
                    <small style="color:#718096">Всего пользователей: <span id="admin-users-count">0</span></small>
                </div>
                <input type="text" class="search-bar" id="admin-search-input" placeholder="Поиск юзера по ID или имени..." onkeyup="filterAdminUsers()">
                
                <div id="admin-user-list">
                    <p style="text-align: center; color: #888;">Загрузка...</p>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div class="header">
                <i class="fas fa-arrow-left back-button" onclick="closeChatMobile()"></i>
                
                <div id="companion-profile-link" style="cursor:pointer; display:none; flex-grow:1; display:flex; align-items:center;" onclick="if(activeChatPartnerId) fetchCompanionProfile(activeChatPartnerId)">
                    <img id="companion-avatar" class="avatar" src="" alt="Avatar" style="margin-right: 15px;">
                    <div>
                        <div id="companion-displayname" style="font-weight: 600; font-size: 1rem;">Имя</div>
                        <div id="companion-username" style="font-weight: 400; font-size: 0.85rem; color: var(--text-secondary);">@username</div>
                    </div>
                </div>
                
                <span id="chat-start-title">Vault Messenger</span> 
            </div>

            <div id="messages-container">
                <div id="chat-start-message" style="margin-top:auto; text-align:center; color:#a0aec0; padding-bottom: 50px;">
                    <i class="fas fa-paper-plane" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                    <p>Выберите чат, чтобы начать общение</p>
                </div>
            </div>

            <div id="input-area" class="hidden">
                <input type="text" id="message-input" placeholder="Сообщение...">
                <button id="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        
        <div id="profile-modal">
            <div>
                <button id="close-profile-modal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.2rem; color: var(--text-secondary); cursor: pointer;"><i class="fas fa-times"></i></button>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <img id="modal-avatar" class="avatar" src="" alt="Avatar" style="width: 100px; height: 100px; margin-bottom: 20px;">
                    <h3 id="modal-displayname" style="font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; text-align: center;"></h3>
                    <p id="modal-username" style="color: var(--text-secondary); margin-bottom: 25px; font-size: 1rem; text-align: center;">@</p>
                    
                    <div style="width: 100%; background: #f8fafc; padding: 15px; border-radius: var(--radius-elem); text-align: left;">
                        <p style="font-weight: 600; margin-bottom: 5px; color: var(--text-main);">О себе:</p>
                        <p id="modal-bio" style="color: var(--text-secondary); white-space: pre-wrap; font-size: 0.95rem;">Информация отсутствует.</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <script>
        // --------------------------------------
        // JAVASCRIPT ЛОГИКА
        // --------------------------------------
        
        const API_URL = ''; 
        const GRAVATAR_BASE_URL = 'https://www.gravatar.com/avatar/';
        // НОВОЕ: Аватар-заглушка по умолчанию
        const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#cbd5e0"/><circle cx="50" cy="40" r="15" fill="#fff"/><circle cx="50" cy="80" r="25" fill="#fff"/></svg>';
        
        let currentUser = null;
        let activeChatPartnerId = null;
        let activeChatPartnerName = null;
        let activeChatPartnerAvatarBase64 = null;
        let activeChatPartnerEmailHash = null;
        let pollingInterval;
        let newAvatarBase64 = null; 
        
        let adminUsersCache = [];

        // --- UTILS ---
        
        function getGravatarUrl(hash, size = 80) { return `${GRAVATAR_BASE_URL}${hash}?s=${size}&d=identicon`; }
        function getAvatarUrl(base64Data, emailHash, size = 80) {
            if (base64Data && base64Data.startsWith('data:image')) return base64Data;
            return getGravatarUrl(emailHash, size);
        }
        function setAuthMessage(msg, isError = false) {
            const el = document.getElementById('auth-message');
            el.innerText = msg;
            el.style.color = isError ? '#e53e3e' : '#38a169';
        }
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            // Прокрутка вниз с небольшим таймаутом, чтобы гарантировать, что все элементы отрисованы
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 50);
        }

        function previewAvatar(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profile-avatar').src = e.target.result;
                    newAvatarBase64 = e.target.result;
                };
                reader.readAsDataURL(file); 
            }
        }
        
        // --- AUTH ---

        function showRegister() {
            document.getElementById('login-button').style.display = 'none';
            document.getElementById('register-button').onclick = handleRegister;
            document.getElementById('register-button').innerText = 'Зарегистрироваться';
            document.getElementById('auth-display-name').style.display = 'block';
            setAuthMessage("");
        }

        async function handleRegister() {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const displayName = document.getElementById('auth-display-name').value;

            try {
                const response = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, displayName })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    setAuthMessage(data.message + ". Теперь войдите.");
                    document.getElementById('auth-display-name').style.display = 'none';
                    document.getElementById('login-button').style.display = 'block';
                    document.getElementById('register-button').innerText = 'Создать аккаунт';
                    document.getElementById('register-button').onclick = showRegister;
                } else setAuthMessage(data.message, true);
            } catch (e) { setAuthMessage("Ошибка сети", true); }
        }

        async function handleLogin() {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            try {
                const response = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    currentUser = data.user;
                    localStorage.setItem('vault_user', JSON.stringify(currentUser));
                    initializeApp();
                } else setAuthMessage(data.message, true);
            } catch (e) { setAuthMessage("Ошибка сети", true); }
        }

        function logout() {
            currentUser = null;
            activeChatPartnerId = null;
            clearInterval(pollingInterval);
            localStorage.removeItem('vault_user');
            document.getElementById('app').style.display = 'none';
            document.getElementById('auth-view').style.display = 'block';
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-password').value = '';
            setAuthMessage('');
            document.body.classList.remove('chat-active');
        }

        // --- APP LOGIC ---
        
        function initializeApp() {
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            const adminButton = document.getElementById('admin-tab-button');
            if (currentUser.role === 'admin') adminButton.classList.remove('hidden');
            else adminButton.classList.add('hidden');

            showTab('chats');
            
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(() => {
                if (activeChatPartnerId) renderMessages(activeChatPartnerId, false);
                renderChatList();
            }, 5000); 
        }

        function showTab(tabName) {
            const tabs = ['chats', 'search', 'profile', 'admin'];
            if (tabName === 'admin' && currentUser.role !== 'admin') tabName = 'chats'; 

            tabs.forEach(tab => {
                const tabEl = document.getElementById(`${tab}-tab`);
                const btnEl = document.querySelector(`.tab-button[onclick*="${tab}"]`);
                if (tabEl) tabEl.classList.toggle('hidden', tab !== tabName);
                if (btnEl) btnEl.classList.toggle('active', tab === tabName);
            });
            
            if (tabName === 'profile') loadProfile();
            if (tabName === 'chats') renderChatList();
            if (tabName === 'admin') loadAdminUsers(); 
            if (tabName === 'search') {
                document.getElementById('search-input').value = ''; 
                document.getElementById('search-list').innerHTML = '';
            }
        }
        
        // ИЗМЕНЕНО: Сброс заголовка чата
        function closeChatMobile() {
            document.body.classList.remove('chat-active');
            activeChatPartnerId = null;
            
            // Сброс заголовка на стартовый
            document.getElementById('chat-start-title').style.display = 'block';
            document.getElementById('companion-profile-link').style.display = 'none';
            
            document.getElementById('input-area').classList.add('hidden');
        }

        // --- CHATS & MESSAGES ---

        async function renderChatList() {
            const chatList = document.getElementById('chats-tab');
            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'chats', user_id: currentUser.id })
            });
            const data = await response.json();
            
            let htmlContent = '';
            if (data.status === 'success') {
                if (data.chats.length === 0) {
                     htmlContent = '<li style="padding: 20px; text-align:center; color:#a0aec0;">Нет чатов</li>';
                } else {
                    data.chats.forEach(partner => {
                        const avatarSrc = getAvatarUrl(partner.avatarBase64, partner.emailHash, 50);
                        const isActive = activeChatPartnerId === partner.id ? ' active' : '';
                        htmlContent += `
                            <li class="chat-item${isActive}" onclick="openChat('${partner.id}', '${partner.displayName}', '${partner.avatarBase64}', '${partner.emailHash}')">
                                <img class="avatar" src="${avatarSrc}">
                                <div class="details">
                                    <div class="name">${partner.displayName}</div>
                                    <div class="last-message">@${partner.id}</div>
                                </div>
                            </li>`;
                    });
                }
            }
            chatList.innerHTML = htmlContent;
        }
        
        // ИЗМЕНЕНО: Установка данных в кликабельный заголовок
        function openChat(pId, pName, pAvatar, pHash) {
            activeChatPartnerId = pId;
            activeChatPartnerName = pName;
            activeChatPartnerAvatarBase64 = pAvatar;
            activeChatPartnerEmailHash = pHash;

            document.getElementById('input-area').classList.remove('hidden');
            
            // Установка данных в кликабельный заголовок
            const profileLinkEl = document.getElementById('companion-profile-link');
            profileLinkEl.style.display = 'flex';
            document.getElementById('chat-start-title').style.display = 'none'; // Скрываем стартовый заголовок

            document.getElementById('companion-avatar').src = getAvatarUrl(pAvatar, pHash, 50);
            document.getElementById('companion-displayname').innerText = pName;
            document.getElementById('companion-username').innerText = `@${pId}`; // ID как юзернейм
            
            document.body.classList.add('chat-active');

            renderMessages(pId, true); 
            renderChatList(); 
        }
        
        async function renderMessages(partnerId, forceScroll = false) {
            const container = document.getElementById('messages-container');
            
            // Если мы не принудительно скроллим, проверяем, был ли пользователь внизу контейнера
            const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;

            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'history', user_a: currentUser.id, user_b: partnerId })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                let htmlContent = '';
                if (data.messages.length === 0) {
                     // Добавляем "маргин" только к сообщению-заглушке, и только когда нет сообщений,
                     // чтобы оно было внизу, но не ломало рендеринг истории
                     htmlContent = '<div style="margin-top:auto; text-align:center; color:#a0aec0; padding-bottom:50px;"><p>Чат пуст. Начните общение.</p></div>';
                } else {
                    // *** НЕТ ПУШЕРА. Сообщения начинаются сверху. ***
                    
                    const partnerAvatar = activeChatPartnerAvatarBase64;
                    const partnerHash = activeChatPartnerEmailHash;
                    
                    data.messages.forEach(msg => {
                        const isSent = msg.sender === currentUser.id;
                        const senderBase64 = isSent ? currentUser.avatarBase64 : partnerAvatar;
                        const senderHash = isSent ? currentUser.emailHash : partnerHash;
                        const avatarSrc = getAvatarUrl(senderBase64, senderHash, 35);
                        const rowClass = isSent ? 'sent' : 'received';

                        htmlContent += `
                            <div class="message-row ${rowClass}">
                                <img class="avatar" src="${avatarSrc}">
                                <div class="message ${rowClass}">
                                    ${msg.text} 
                                    <span class="message-info">${msg.timestamp}</span>
                                </div>
                            </div>`;
                    });
                }
                
                container.innerHTML = htmlContent;
                
                // Скроллим вниз, если это открытие чата или юзер уже был внизу
                if (forceScroll || isAtBottom) {
                    scrollToBottom();
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !activeChatPartnerId) return;
            
            // Временно добавляем сообщение на экран для мгновенного отклика (оптимизация UX)
            const tempContainer = document.getElementById('messages-container');
            const tempMsgHtml = `
                <div class="message-row sent">
                    <img class="avatar" src="${getAvatarUrl(currentUser.avatarBase64, currentUser.emailHash, 35)}">
                    <div class="message sent">
                        ${text} 
                        <span class="message-info">${new Date().toLocaleTimeString('ru-RU')} (отправка...)</span>
                    </div>
                </div>`;
            tempContainer.insertAdjacentHTML('beforeend', tempMsgHtml);
            scrollToBottom();


            await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'send', sender_id: currentUser.id, receiver_id: activeChatPartnerId, text: text 
                })
            });
            input.value = ''; 
            await renderMessages(activeChatPartnerId, true); 
            renderChatList();
        }

        // --- SEARCH ---

        async function handleSearch() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('search-list');
            list.innerHTML = '';
            if (term.length < 2) return;

            const response = await fetch(`${API_URL}/api/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_user_id: currentUser.id, term: term })
            });
            const data = await response.json();

            if (data.status === 'success') {
                data.results.forEach(user => {
                    const avatarSrc = getAvatarUrl(user.avatarBase64, user.emailHash, 50);
                    const li = document.createElement('li');
                    li.className = 'user-item';
                    li.innerHTML = `
                        <img class="avatar" src="${avatarSrc}">
                        <div class="details">
                            <div class="name">${user.displayName}</div>
                            <div class="id">@${user.id}</div>
                        </div>
                        <button class="tab-button" style="width:auto; background:#38a169; color:white;" 
                                onclick="openChat('${user.id}', '${user.displayName}', '${user.avatarBase64}', '${user.emailHash}'); showTab('chats');">
                            Чат
                        </button>`;
                    list.appendChild(li);
                });
            }
        }

        // --- PROFILE ---

        async function loadProfile() {
            document.getElementById('profile-username-display').innerText = `@${currentUser.id}`;
            document.getElementById('profile-avatar').src = getAvatarUrl(currentUser.avatarBase64, currentUser.emailHash, 100);
            const response = await fetch(`${API_URL}/api/profile/${currentUser.id}`);
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('edit-display-name').value = data.profile.displayName;
                document.getElementById('edit-bio').value = data.profile.bio;
                const currentAvatar = data.profile.avatarBase64 || "";
                document.getElementById('profile-avatar').src = getAvatarUrl(currentAvatar, currentUser.emailHash, 100);
            }
            newAvatarBase64 = null; 
            document.getElementById('avatar-input').value = null; 
        }

        async function saveProfileChanges() {
            const displayName = document.getElementById('edit-display-name').value;
            const bio = document.getElementById('edit-bio').value;
            const bodyData = { displayName, bio };
            if (newAvatarBase64 !== null) bodyData.avatarBase64 = newAvatarBase64;

            const response = await fetch(`${API_URL}/api/profile/${currentUser.id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            const data = await response.json();
            if (data.status === 'success') {
                currentUser.displayName = data.profile.displayName;
                currentUser.avatarBase64 = data.profile.avatarBase64 || "";
                localStorage.setItem('vault_user', JSON.stringify(currentUser));
                alert('Профиль сохранен!');
                loadProfile();
            } else alert('Ошибка: ' + data.message);
        }
        
        // --- НОВЫЕ ФУНКЦИИ ДЛЯ ПРОФИЛЯ СОБЕСЕДНИКА ---

        function openProfileModal(user) {
            document.getElementById('modal-avatar').src = getAvatarUrl(user.avatarBase64, user.emailHash, 100) || DEFAULT_AVATAR;
            document.getElementById('modal-displayname').textContent = user.displayName;
            document.getElementById('modal-username').textContent = `@${user.id}`;
            const bioText = user.bio && user.bio.trim() ? user.bio : 'Информация о себе не указана.';
            document.getElementById('modal-bio').textContent = bioText;
            document.getElementById('profile-modal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        async function fetchCompanionProfile(userId) {
            try {
                // Предполагаем, что бэкенд имеет маршрут /api/user/<ID>
                const response = await fetch(`${API_URL}/api/user/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    openProfileModal(data.user);
                } else {
                    alert(data.message || 'Ошибка при загрузке профиля.');
                }
            } catch (error) {
                console.error('Ошибка при запросе профиля:', error);
                alert('Не удалось подключиться к серверу для загрузки профиля.');
            }
        }
        
        // --- ADMIN PANEL & SEARCH ---

        async function loadAdminUsers() {
            const userListEl = document.getElementById('admin-user-list');
            userListEl.innerHTML = '<p style="text-align: center; color: #888;">Загрузка...</p>';
            
            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'list', admin_id: currentUser.id })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                adminUsersCache = data.users;
                document.getElementById('admin-users-count').innerText = adminUsersCache.length;
                renderAdminList(adminUsersCache);
            } else {
                userListEl.innerHTML = `<p style="text-align: center; color: #e53e3e;">Ошибка: ${data.message}</p>`;
            }
        }

        function renderAdminList(users) {
            const userListEl = document.getElementById('admin-user-list');
            if (users.length === 0) {
                userListEl.innerHTML = '<p style="text-align:center; color:#a0aec0;">Пользователи не найдены.</p>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const isBanned = user.is_banned === 1;
                const bannedText = isBanned ? '<span style="color:red; font-weight:bold;">(BAN)</span>' : '';
                html += `
                    <div class="admin-user-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 style="margin:0;">@${user.id} ${bannedText}</h4>
                            <span style="font-size:0.8em; background:#edf2f7; padding:2px 6px; border-radius:4px;">${user.role}</span>
                        </div>
                        
                        <div style="margin-top:10px;">
                            <input type="text" id="admin-name-${user.id}" value="${user.displayName}" placeholder="Имя" style="margin-bottom:5px; padding:8px;">
                            <input type="password" id="admin-pass-${user.id}" placeholder="Сменить пароль" style="margin-bottom:5px; padding:8px;">
                        </div>
                        
                        <div class="admin-actions">
                            <button class="admin-save-btn" onclick="adminEditUser('${user.id}')">Сохранить</button>
                            ${isBanned 
                                ? `<button class="admin-unban-btn" onclick="adminBanUser('${user.id}', 0)">Разбанить</button>`
                                : `<button class="admin-ban-btn" onclick="adminBanUser('${user.id}', 1)">Забанить</button>`
                            }
                        </div>
                    </div>`;
            });
            userListEl.innerHTML = html;
        }

        function filterAdminUsers() {
            const term = document.getElementById('admin-search-input').value.toLowerCase();
            const filtered = adminUsersCache.filter(user => 
                user.id.toLowerCase().includes(term) || 
                user.displayName.toLowerCase().includes(term)
            );
            renderAdminList(filtered);
        }
        
        async function adminEditUser(targetId) {
            const newDisplayName = document.getElementById(`admin-name-${targetId}`).value;
            const newPassword = document.getElementById(`admin-pass-${targetId}`).value;
            
            const bodyData = { 
                action: 'edit', admin_id: currentUser.id, target_id: targetId, displayName: newDisplayName,
            };
            if (newPassword.trim()) bodyData.password = newPassword.trim();

            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });
            const data = await response.json();
            alert(data.message);
            if (data.status === 'success') document.getElementById(`admin-pass-${targetId}`).value = ''; 
        }
        
        async function adminBanUser(targetId, isBanned) {
            if (!confirm(`Вы уверены?`)) return;
            const response = await fetch(`${API_URL}/api/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'edit', admin_id: currentUser.id, target_id: targetId, is_banned: isBanned, 
                })
            });
            const data = await response.json();
            alert(data.message);
            if (data.status === 'success') loadAdminUsers(); 
        }

        // --- INIT ---
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        window.onload = () => {
            const storedUser = localStorage.getItem('vault_user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                initializeApp();
            } else {
                document.getElementById('auth-view').style.display = 'block';
            }
            
            // НОВОЕ: Обработчики для модального окна профиля
            document.getElementById('close-profile-modal').addEventListener('click', closeProfileModal);
            document.getElementById('profile-modal').addEventListener('click', (e) => {
                if (e.target.id === 'profile-modal') {
                    closeProfileModal();
                }
            });
        };
    </script>
</body>
</html>